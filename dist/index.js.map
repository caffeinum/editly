{"version":3,"file":"index.js","sources":["../src/ffmpeg.ts","../src/audio.ts","../src/api/defineFrameSource.ts","../src/BoxBlur.js","../src/sources/fabric.ts","../src/sources/canvas.ts","../src/colors.ts","../src/sources/fill-color.ts","../src/sources/gl.ts","../src/util.ts","../src/sources/image-overlay.ts","../src/sources/image.ts","../src/sources/linear-gradient.ts","../src/easings.ts","../src/sources/news-title.ts","../src/sources/radial-gradient.ts","../src/sources/slide-in-text.ts","../src/sources/subtitle.ts","../src/sources/title.ts","../src/transforms/rawVideoToFrames.ts","../src/sources/video.ts","../src/sources/index.ts","../src/configuration.ts","../src/frameSource.ts","../src/transition.ts","../src/parseConfig.ts","../src/index.ts"],"sourcesContent":["import assert from \"assert\";\nimport { compareVersions } from \"compare-versions\";\nimport { execa, type Options } from \"execa\";\nimport fsExtra from \"fs-extra\";\nimport { FfmpegConfig } from \"./configuration.js\";\n\nexport type Stream = {\n  codec_type: string;\n  codec_name: string;\n  r_frame_rate: string;\n  width?: number;\n  height?: number;\n  tags?: {\n    rotate: string;\n  };\n  side_data_list?: {\n    rotation: string;\n  }[];\n};\n\nconst config: Required<FfmpegConfig> = {\n  ffmpegPath: \"ffmpeg\",\n  ffprobePath: \"ffprobe\",\n  enableFfmpegLog: false,\n};\n\nexport function getFfmpegCommonArgs() {\n  return [\"-hide_banner\", ...(config.enableFfmpegLog ? [] : [\"-loglevel\", \"error\"])];\n}\n\nexport function getCutFromArgs({ cutFrom }: { cutFrom?: number }) {\n  return cutFrom ? [\"-ss\", cutFrom.toString()] : [];\n}\n\nexport function getCutToArgs({\n  cutTo,\n  cutFrom,\n  speedFactor,\n}: {\n  cutTo?: number;\n  cutFrom?: number;\n  speedFactor: number;\n}) {\n  return cutFrom && cutTo ? [\"-t\", (cutTo - cutFrom) * speedFactor] : [];\n}\n\nexport async function createConcatFile(segments: string[], concatFilePath: string) {\n  // https://superuser.com/questions/787064/filename-quoting-in-ffmpeg-concat\n  await fsExtra.writeFile(\n    concatFilePath,\n    segments.map((seg) => `file '${seg.replace(/'/g, \"'\\\\''\")}'`).join(\"\\n\"),\n  );\n}\n\nexport async function testFf(exePath: string, name: string) {\n  const minRequiredVersion = \"4.3.1\";\n\n  try {\n    const { stdout } = await execa(exePath, [\"-version\"]);\n    const firstLine = stdout.split(\"\\n\")[0];\n    const match = firstLine.match(`${name} version ([0-9.]+)`);\n    assert(match, \"Unknown version string\");\n    const versionStr = match[1];\n    console.log(`${name} version ${versionStr}`);\n    assert(compareVersions(versionStr, minRequiredVersion), \"Version is outdated\");\n  } catch (err) {\n    console.error(`WARNING: ${name}:`, err);\n  }\n}\n\nexport async function configureFf(params: Partial<FfmpegConfig>) {\n  Object.assign(config, params);\n  await testFf(config.ffmpegPath, \"ffmpeg\");\n  await testFf(config.ffprobePath, \"ffprobe\");\n}\n\nexport function ffmpeg(args: string[], options?: Options) {\n  if (config.enableFfmpegLog) console.log(`$ ${config.ffmpegPath} ${args.join(\" \")}`);\n  return execa(config.ffmpegPath, [...getFfmpegCommonArgs(), ...args], options);\n}\n\nexport function ffprobe(args: string[]) {\n  return execa(config.ffprobePath, args);\n}\n\nexport function parseFps(fps?: string) {\n  const match = typeof fps === \"string\" && fps.match(/^([0-9]+)\\/([0-9]+)$/);\n  if (match) {\n    const num = parseInt(match[1], 10);\n    const den = parseInt(match[2], 10);\n    if (den > 0) return num / den;\n  }\n  return undefined;\n}\n\nexport async function readDuration(p: string) {\n  const { stdout } = await ffprobe([\n    \"-v\",\n    \"error\",\n    \"-show_entries\",\n    \"format=duration\",\n    \"-of\",\n    \"default=noprint_wrappers=1:nokey=1\",\n    p,\n  ]);\n  const parsed = parseFloat(stdout);\n  assert(!Number.isNaN(parsed));\n  return parsed;\n}\n\nexport async function readFileStreams(p: string) {\n  const { stdout } = await ffprobe([\"-show_entries\", \"stream\", \"-of\", \"json\", p]);\n  return JSON.parse(stdout).streams as Stream[];\n}\n\nexport async function readVideoFileInfo(p: string) {\n  const streams = await readFileStreams(p);\n  const stream = streams.find((s) => s.codec_type === \"video\"); // TODO\n\n  if (!stream) {\n    throw new Error(`Could not find a video stream in ${p}`);\n  }\n\n  const duration = await readDuration(p);\n\n  let rotation = parseInt(stream.tags?.rotate ?? \"\", 10);\n\n  // If we can't find rotation, try side_data_list\n  if (Number.isNaN(rotation) && stream.side_data_list?.[0]?.rotation) {\n    rotation = parseInt(stream.side_data_list[0].rotation, 10);\n  }\n\n  return {\n    // numFrames: parseInt(stream.nb_frames, 10),\n    duration,\n    width: stream.width, // TODO coded_width?\n    height: stream.height,\n    framerateStr: stream.r_frame_rate,\n    rotation: !Number.isNaN(rotation) ? rotation : undefined,\n  };\n}\n","import { flatMap } from \"lodash-es\";\nimport pMap from \"p-map\";\nimport { basename, join, resolve } from \"path\";\nimport type { Configuration } from \"./configuration.js\";\nimport { ffmpeg, getCutFromArgs, readFileStreams } from \"./ffmpeg.js\";\nimport type { TransitionOptions } from \"./transition.js\";\nimport type {\n  AudioLayer,\n  AudioNormalizationOptions,\n  AudioTrack,\n  Clip,\n  VideoLayer,\n} from \"./types.js\";\n\nexport type AudioOptions = {\n  verbose: boolean;\n  tmpDir: string;\n};\n\nexport type EditAudioOptions = Pick<\n  Configuration,\n  \"keepSourceAudio\" | \"clips\" | \"clipsAudioVolume\" | \"audioNorm\" | \"outputVolume\"\n> & {\n  arbitraryAudio: AudioTrack[];\n};\n\ntype LayerWithAudio = (AudioLayer | VideoLayer) & { speedFactor: number };\n\nexport default ({ verbose, tmpDir }: AudioOptions) => {\n  async function createMixedAudioClips({\n    clips,\n    keepSourceAudio,\n  }: {\n    clips: Clip[];\n    keepSourceAudio?: boolean;\n  }) {\n    return pMap(\n      clips,\n      async (clip, i) => {\n        const { duration, layers, transition } = clip;\n\n        async function runInner(): Promise<{ clipAudioPath: string; silent: boolean }> {\n          const clipAudioPath = join(tmpDir, `clip${i}-audio.flac`);\n\n          async function createSilence() {\n            if (verbose) console.log(\"create silence\", duration);\n            const args = [\n              \"-nostdin\",\n              \"-f\",\n              \"lavfi\",\n              \"-i\",\n              \"anullsrc=channel_layout=stereo:sample_rate=44100\",\n              \"-sample_fmt\",\n              \"s32\",\n              \"-ar\",\n              \"48000\",\n              \"-t\",\n              duration!.toString(),\n              \"-c:a\",\n              \"flac\",\n              \"-y\",\n              clipAudioPath,\n            ];\n            await ffmpeg(args);\n\n            return { silent: true, clipAudioPath };\n          }\n\n          // Has user enabled keep source audio?\n          if (!keepSourceAudio) return createSilence();\n\n          // TODO:[ts]: Layers is always an array once config is parsed. Fix this in types\n          const audioLayers = layers.filter(\n            ({ type, start, stop }) =>\n              [\"audio\", \"video\"].includes(type) &&\n              // TODO: We don't support audio for start/stop layers\n              !start &&\n              stop == null,\n          ) as LayerWithAudio[];\n\n          if (audioLayers.length === 0) return createSilence();\n\n          const processedAudioLayersRaw = await pMap(\n            audioLayers,\n            async (audioLayer, j) => {\n              const { path, cutFrom, cutTo, speedFactor } = audioLayer;\n\n              const streams = await readFileStreams(path);\n              if (!streams.some((s) => s.codec_type === \"audio\")) return undefined;\n\n              const layerAudioPath = join(tmpDir, `clip${i}-layer${j}-audio.flac`);\n\n              try {\n                let atempoFilter;\n                if (Math.abs(speedFactor - 1) > 0.01) {\n                  if (verbose) console.log(\"audio speedFactor\", speedFactor);\n                  const atempo = 1 / speedFactor;\n                  if (!(atempo >= 0.5 && atempo <= 100)) {\n                    // Required range by ffmpeg\n                    console.warn(\n                      `Audio speed ${atempo} is outside accepted range, using silence (clip ${i})`,\n                    );\n                    return undefined;\n                  }\n                  atempoFilter = `atempo=${atempo}`;\n                }\n\n                const cutToArg = (cutTo! - cutFrom!) * speedFactor;\n\n                const args = [\n                  \"-nostdin\",\n                  ...getCutFromArgs({ cutFrom }),\n                  \"-i\",\n                  path,\n                  \"-t\",\n                  cutToArg!.toString(),\n                  \"-sample_fmt\",\n                  \"s32\",\n                  \"-ar\",\n                  \"48000\",\n                  \"-map\",\n                  \"a:0\",\n                  \"-c:a\",\n                  \"flac\",\n                  ...(atempoFilter ? [\"-filter:a\", atempoFilter] : []),\n                  \"-y\",\n                  layerAudioPath,\n                ];\n\n                await ffmpeg(args);\n\n                return [layerAudioPath, audioLayer];\n              } catch (err) {\n                if (verbose) console.error(\"Cannot extract audio from video\", path, err);\n                // Fall back to silence\n                return undefined;\n              }\n            },\n            { concurrency: 4 },\n          );\n\n          const processedAudioLayers = processedAudioLayersRaw.filter(\n            (r): r is [string, LayerWithAudio] => r !== undefined,\n          );\n\n          if (processedAudioLayers.length < 1) return createSilence();\n\n          if (processedAudioLayers.length === 1)\n            return { clipAudioPath: processedAudioLayers[0][0], silent: false };\n\n          // Merge/mix all layers' audio\n          const weights = processedAudioLayers.map(([, { mixVolume }]) => mixVolume ?? 1);\n          const args = [\n            \"-nostdin\",\n            ...flatMap(processedAudioLayers, ([layerAudioPath]) => [\"-i\", layerAudioPath]),\n            \"-filter_complex\",\n            `amix=inputs=${processedAudioLayers.length}:duration=longest:weights=${weights.join(\" \")}`,\n            \"-c:a\",\n            \"flac\",\n            \"-y\",\n            clipAudioPath,\n          ];\n\n          await ffmpeg(args);\n          return { clipAudioPath, silent: false };\n        }\n\n        const { clipAudioPath, silent } = await runInner();\n\n        return {\n          path: resolve(clipAudioPath), // https://superuser.com/a/853262/658247\n          transition,\n          silent,\n        };\n      },\n      { concurrency: 4 },\n    );\n  }\n\n  async function crossFadeConcatClipAudio(\n    clipAudio: { path: string; transition?: TransitionOptions | null }[],\n  ) {\n    if (clipAudio.length < 2) {\n      return clipAudio[0].path;\n    }\n\n    const outPath = join(tmpDir, \"audio-concat.flac\");\n\n    if (verbose)\n      console.log(\n        \"Combining audio\",\n        clipAudio.map(({ path }) => basename(path)),\n      );\n\n    let inStream = \"[0:a]\";\n    const filterGraph = clipAudio\n      .slice(0, -1)\n      .map(({ transition }, i) => {\n        const outStream = `[concat${i}]`;\n\n        const epsilon = 0.0001; // If duration is 0, ffmpeg seems to default to 1 sec instead, hence epsilon.\n        let ret = `${inStream}[${i + 1}:a]acrossfade=d=${Math.max(epsilon, transition?.duration ?? 0)}:c1=${transition?.audioOutCurve ?? \"tri\"}:c2=${transition?.audioInCurve ?? \"tri\"}`;\n\n        inStream = outStream;\n\n        if (i < clipAudio.length - 2) ret += outStream;\n        return ret;\n      })\n      .join(\",\");\n\n    const args = [\n      \"-nostdin\",\n      ...flatMap(clipAudio, ({ path }) => [\"-i\", path]),\n      \"-filter_complex\",\n      filterGraph,\n      \"-c\",\n      \"flac\",\n      \"-y\",\n      outPath,\n    ];\n    await ffmpeg(args);\n\n    return outPath;\n  }\n\n  // FIXME[ts]: parseConfig sets `loop` on arbitrary audio tracks. Should that be part of the `AudioTrack` interface?\n  async function mixArbitraryAudio({\n    streams,\n    audioNorm,\n    outputVolume,\n  }: {\n    streams: (AudioTrack & { loop?: number })[];\n    audioNorm?: AudioNormalizationOptions;\n    outputVolume?: number | string;\n  }) {\n    let maxGain = 30;\n    let gaussSize = 5;\n    if (audioNorm) {\n      if (audioNorm.gaussSize != null) gaussSize = audioNorm.gaussSize;\n      if (audioNorm.maxGain != null) maxGain = audioNorm.maxGain;\n    }\n    const enableAudioNorm = audioNorm && audioNorm.enable;\n\n    // https://stackoverflow.com/questions/35509147/ffmpeg-amix-filter-volume-issue-with-inputs-of-different-duration\n    let filterComplex = streams\n      .map(({ start, cutFrom, cutTo }, i) => {\n        const cutToArg = cutTo != null ? `:end=${cutTo}` : \"\";\n        const apadArg = i > 0 ? \",apad\" : \"\"; // Don't pad the first track (audio from video clips with correct duration)\n\n        return `[${i}:a]atrim=start=${cutFrom || 0}${cutToArg},adelay=delays=${Math.floor((start || 0) * 1000)}:all=1${apadArg}[a${i}]`;\n      })\n      .join(\";\");\n\n    const volumeArg = outputVolume != null ? `,volume=${outputVolume}` : \"\";\n    const audioNormArg = enableAudioNorm ? `,dynaudnorm=g=${gaussSize}:maxgain=${maxGain}` : \"\";\n    filterComplex += `;${streams.map((_, i) => `[a${i}]`).join(\"\")}amix=inputs=${streams.length}:duration=first:dropout_transition=0:weights=${streams.map((s) => (s.mixVolume != null ? s.mixVolume : 1)).join(\" \")}${audioNormArg}${volumeArg}`;\n\n    const mixedAudioPath = join(tmpDir, \"audio-mixed.flac\");\n\n    const args = [\n      \"-nostdin\",\n      ...flatMap(streams, ({ path, loop }) => [\"-stream_loop\", (loop || 0).toString(), \"-i\", path]),\n      \"-vn\",\n      \"-filter_complex\",\n      filterComplex,\n      \"-c:a\",\n      \"flac\",\n      \"-y\",\n      mixedAudioPath,\n    ];\n\n    await ffmpeg(args);\n\n    return mixedAudioPath;\n  }\n\n  async function editAudio({\n    keepSourceAudio,\n    clips,\n    arbitraryAudio,\n    clipsAudioVolume,\n    audioNorm,\n    outputVolume,\n  }: EditAudioOptions) {\n    // We need clips to process audio, because we need to know duration\n    if (clips.length === 0) return undefined;\n\n    // No need to process audio if none of these are satisfied\n    if (!(keepSourceAudio || arbitraryAudio.length > 0)) return undefined;\n\n    console.log(\"Extracting audio/silence from all clips\");\n\n    // Mix audio from each clip as separate files (or silent audio of appropriate length for clips with no audio)\n    const clipAudio = await createMixedAudioClips({ clips, keepSourceAudio });\n\n    // Return no audio if only silent clips and no arbitrary audio\n    if (clipAudio.every((ca) => ca.silent) && arbitraryAudio.length === 0) return undefined;\n\n    // Merge & fade the clip audio files\n    const concatedClipAudioPath = await crossFadeConcatClipAudio(clipAudio);\n\n    const streams: AudioTrack[] = [\n      // The first stream is required, as it determines the length of the output audio.\n      // All other streams will be truncated to its length\n      { path: concatedClipAudioPath, mixVolume: clipsAudioVolume },\n\n      ...arbitraryAudio,\n    ];\n\n    console.log(\"Mixing clip audio with arbitrary audio\");\n\n    if (streams.length < 2) return concatedClipAudioPath;\n\n    const mixedFile = await mixArbitraryAudio({ streams, audioNorm, outputVolume });\n    return mixedFile;\n  }\n\n  return {\n    editAudio,\n  };\n};\n","import type { StaticCanvas } from \"fabric/node\";\nimport type { DebugOptions } from \"../configuration.js\";\nimport type { BaseLayer, OptionalPromise } from \"../types.js\";\n\n/**\n * A public API for defining new frame sources.\n */\nexport function defineFrameSource<T extends BaseLayer>(\n  type: T[\"type\"],\n  setup: FrameSourceSetupFunction<T>,\n): FrameSourceFactory<T> {\n  return {\n    type,\n    async setup(options: CreateFrameSourceOptions<T>) {\n      return new FrameSource<T>(options, await setup(options));\n    },\n  };\n}\n\nexport type CreateFrameSourceOptions<T> = DebugOptions & {\n  width: number;\n  height: number;\n  duration: number;\n  channels: number;\n  framerateStr: string;\n  params: T;\n};\n\nexport interface FrameSourceFactory<T extends BaseLayer> {\n  type: T[\"type\"];\n  setup: (fn: CreateFrameSourceOptions<T>) => Promise<FrameSource<T>>;\n}\n\nexport interface FrameSourceImplementation {\n  readNextFrame(\n    progress: number,\n    canvas: StaticCanvas,\n    offsetTime: number,\n  ): OptionalPromise<Buffer | void>;\n  close?(): OptionalPromise<void | undefined>;\n}\n\nexport type FrameSourceSetupFunction<T> = (\n  fn: CreateFrameSourceOptions<T>,\n) => Promise<FrameSourceImplementation>;\n\nexport class FrameSource<T extends BaseLayer> {\n  options: CreateFrameSourceOptions<T>;\n  implementation: FrameSourceImplementation;\n\n  constructor(options: CreateFrameSourceOptions<T>, implementation: FrameSourceImplementation) {\n    this.options = options;\n    this.implementation = implementation;\n  }\n\n  async readNextFrame(time: number, canvas: StaticCanvas) {\n    const { start, layerDuration } = this.layer;\n\n    const offsetTime = time - (start ?? 0);\n    const offsetProgress = offsetTime / layerDuration!;\n    const shouldDrawLayer = offsetProgress >= 0 && offsetProgress <= 1;\n\n    // Skip drawing if the layer has not started or has already ended\n    if (!shouldDrawLayer) return;\n\n    return await this.implementation.readNextFrame(offsetProgress, canvas, offsetTime);\n  }\n\n  async close() {\n    await this.implementation.close?.();\n  }\n\n  get layer() {\n    return this.options.params;\n  }\n}\n","/* eslint-disable */\n/*\n\nSuperfast Blur - a fast Box Blur For Canvas\n\nVersion: 0.5\nAuthor: Mario Klingemann\nContact: mario@quasimondo.com\nWebsite: http://www.quasimondo.com/BoxBlurForCanvas\nTwitter: @quasimondo\n\nIn case you find this class useful - especially in commercial projects -\nI am not totally unhappy for a small donation to my PayPal account\nmario@quasimondo.de\n\nOr support me on flattr:\nhttps://flattr.com/thing/140066/Superfast-Blur-a-pretty-fast-Box-Blur-Effect-for-CanvasJavascript\n\nCopyright (c) 2011 Mario Klingemann\n\nPermission is hereby granted, free of charge, to any person\nobtaining a copy of this software and associated documentation\nfiles (the \"Software\"), to deal in the Software without\nrestriction, including without limitation the rights to use,\ncopy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the\nSoftware is furnished to do so, subject to the following\nconditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\nOF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\nOTHER DEALINGS IN THE SOFTWARE.\n*/\n\n\nvar mul_table = [ 1,57,41,21,203,34,97,73,227,91,149,62,105,45,39,137,241,107,3,173,39,71,65,238,219,101,187,87,81,151,141,133,249,117,221,209,197,187,177,169,5,153,73,139,133,127,243,233,223,107,103,99,191,23,177,171,165,159,77,149,9,139,135,131,253,245,119,231,224,109,211,103,25,195,189,23,45,175,171,83,81,79,155,151,147,9,141,137,67,131,129,251,123,30,235,115,113,221,217,53,13,51,50,49,193,189,185,91,179,175,43,169,83,163,5,79,155,19,75,147,145,143,35,69,17,67,33,65,255,251,247,243,239,59,29,229,113,111,219,27,213,105,207,51,201,199,49,193,191,47,93,183,181,179,11,87,43,85,167,165,163,161,159,157,155,77,19,75,37,73,145,143,141,35,138,137,135,67,33,131,129,255,63,250,247,61,121,239,237,117,29,229,227,225,111,55,109,216,213,211,209,207,205,203,201,199,197,195,193,48,190,47,93,185,183,181,179,178,176,175,173,171,85,21,167,165,41,163,161,5,79,157,78,154,153,19,75,149,74,147,73,144,143,71,141,140,139,137,17,135,134,133,66,131,65,129,1];\n\nvar shg_table = [0,9,10,10,14,12,14,14,16,15,16,15,16,15,15,17,18,17,12,18,16,17,17,19,19,18,19,18,18,19,19,19,20,19,20,20,20,20,20,20,15,20,19,20,20,20,21,21,21,20,20,20,21,18,21,21,21,21,20,21,17,21,21,21,22,22,21,22,22,21,22,21,19,22,22,19,20,22,22,21,21,21,22,22,22,18,22,22,21,22,22,23,22,20,23,22,22,23,23,21,19,21,21,21,23,23,23,22,23,23,21,23,22,23,18,22,23,20,22,23,23,23,21,22,20,22,21,22,24,24,24,24,24,22,21,24,23,23,24,21,24,23,24,22,24,24,22,24,24,22,23,24,24,24,20,23,22,23,24,24,24,24,24,24,24,23,21,23,22,23,24,24,24,22,24,24,24,23,22,24,24,25,23,25,25,23,24,25,25,24,22,25,25,25,24,23,24,25,25,25,25,25,25,25,25,25,25,25,25,23,25,23,24,25,25,25,25,25,25,25,25,25,24,22,25,25,23,25,25,20,24,25,24,25,25,22,24,25,24,25,24,25,25,24,25,25,25,25,22,25,25,25,24,25,24,25,18];\n\n\nexport function boxBlurImage( context, width, height, radius, blurAlphaChannel, iterations ){\n\tif ( isNaN(radius) || radius < 1 ) return;\n\t\n\tif ( blurAlphaChannel )\n\t{\n\t\tboxBlurCanvasRGBA( context, 0, 0, width, height, radius, iterations );\n\t} else {\n\t\tboxBlurCanvasRGB( context, 0, 0, width, height, radius, iterations );\n\t}\n\t\n}\n\n\nfunction boxBlurCanvasRGBA( context, top_x, top_y, width, height, radius, iterations ){\n\tif ( isNaN(radius) || radius < 1 ) return;\n\t\n\tradius |= 0;\n\t\n\tif ( isNaN(iterations) ) iterations = 1;\n\titerations |= 0;\n\tif ( iterations > 3 ) iterations = 3;\n\tif ( iterations < 1 ) iterations = 1;\n\t\n\tvar imageData;\n\t\n\ttry {\n\t  try {\n\t\timageData = context.getImageData( top_x, top_y, width, height );\n\t  } catch(e) {\n\t  \n\t\t// NOTE: this part is supposedly only needed if you want to work with local files\n\t\t// so it might be okay to remove the whole try/catch block and just use\n\t\t// imageData = context.getImageData( top_x, top_y, width, height );\n\t\ttry {\n\t\t\tnetscape.security.PrivilegeManager.enablePrivilege(\"UniversalBrowserRead\");\n\t\t\timageData = context.getImageData( top_x, top_y, width, height );\n\t\t} catch(e) {\n\t\t\talert(\"Cannot access local image\");\n\t\t\tthrow new Error(\"unable to access local image data: \" + e);\n\t\t\treturn;\n\t\t}\n\t  }\n\t} catch(e) {\n\t  alert(\"Cannot access image\");\n\t  throw new Error(\"unable to access image data: \" + e);\n\t  return;\n\t}\n\t\t\t\n\tvar pixels = imageData.data;\n\t\t\n\tvar rsum,gsum,bsum,asum,x,y,i,p,p1,p2,yp,yi,yw,idx,pa;\t\t\n\tvar wm = width - 1;\n  \tvar hm = height - 1;\n    var wh = width * height;\n\tvar rad1 = radius + 1;\n    \n\tvar mul_sum = mul_table[radius];\n\tvar shg_sum = shg_table[radius];\n\n\tvar r = [];\n    var g = [];\n    var b = [];\n\tvar a = [];\n\t\n\tvar vmin = [];\n\tvar vmax = [];\n  \n\twhile ( iterations-- > 0 ){\n\t\tyw = yi = 0;\n\t \n\t\tfor ( y=0; y < height; y++ ){\n\t\t\trsum = pixels[yw]   * rad1;\n\t\t\tgsum = pixels[yw+1] * rad1;\n\t\t\tbsum = pixels[yw+2] * rad1;\n\t\t\tasum = pixels[yw+3] * rad1;\n\t\t\t\n\t\t\t\n\t\t\tfor( i = 1; i <= radius; i++ ){\n\t\t\t\tp = yw + (((i > wm ? wm : i )) << 2 );\n\t\t\t\trsum += pixels[p++];\n\t\t\t\tgsum += pixels[p++];\n\t\t\t\tbsum += pixels[p++];\n\t\t\t\tasum += pixels[p]\n\t\t\t}\n\t\t\t\n\t\t\tfor ( x = 0; x < width; x++ ) {\n\t\t\t\tr[yi] = rsum;\n\t\t\t\tg[yi] = gsum;\n\t\t\t\tb[yi] = bsum;\n\t\t\t\ta[yi] = asum;\n\n\t\t\t\tif( y==0) {\n\t\t\t\t\tvmin[x] = ( ( p = x + rad1) < wm ? p : wm ) << 2;\n\t\t\t\t\tvmax[x] = ( ( p = x - radius) > 0 ? p << 2 : 0 );\n\t\t\t\t} \n\t\t\t\t\n\t\t\t\tp1 = yw + vmin[x];\n\t\t\t\tp2 = yw + vmax[x];\n\t\t\t\t  \n\t\t\t\trsum += pixels[p1++] - pixels[p2++];\n\t\t\t\tgsum += pixels[p1++] - pixels[p2++];\n\t\t\t\tbsum += pixels[p1++] - pixels[p2++];\n\t\t\t\tasum += pixels[p1]   - pixels[p2];\n\t\t\t\t\t \n\t\t\t\tyi++;\n\t\t\t}\n\t\t\tyw += ( width << 2 );\n\t\t}\n\t  \n\t\tfor ( x = 0; x < width; x++ ) {\n\t\t\typ = x;\n\t\t\trsum = r[yp] * rad1;\n\t\t\tgsum = g[yp] * rad1;\n\t\t\tbsum = b[yp] * rad1;\n\t\t\tasum = a[yp] * rad1;\n\t\t\t\n\t\t\tfor( i = 1; i <= radius; i++ ) {\n\t\t\t  yp += ( i > hm ? 0 : width );\n\t\t\t  rsum += r[yp];\n\t\t\t  gsum += g[yp];\n\t\t\t  bsum += b[yp];\n\t\t\t  asum += a[yp];\n\t\t\t}\n\t\t\t\n\t\t\tyi = x << 2;\n\t\t\tfor ( y = 0; y < height; y++) {\n\t\t\t\t\n\t\t\t\tpixels[yi+3] = pa = (asum * mul_sum) >>> shg_sum;\n\t\t\t\tif ( pa > 0 )\n\t\t\t\t{\n\t\t\t\t\tpa = 255 / pa;\n\t\t\t\t\tpixels[yi]   = ((rsum * mul_sum) >>> shg_sum) * pa;\n\t\t\t\t\tpixels[yi+1] = ((gsum * mul_sum) >>> shg_sum) * pa;\n\t\t\t\t\tpixels[yi+2] = ((bsum * mul_sum) >>> shg_sum) * pa;\n\t\t\t\t} else {\n\t\t\t\t\tpixels[yi] = pixels[yi+1] = pixels[yi+2] = 0;\n\t\t\t\t}\t\t\t\t\n\t\t\t\tif( x == 0 ) {\n\t\t\t\t\tvmin[y] = ( ( p = y + rad1) < hm ? p : hm ) * width;\n\t\t\t\t\tvmax[y] = ( ( p = y - radius) > 0 ? p * width : 0 );\n\t\t\t\t} \n\t\t\t  \n\t\t\t\tp1 = x + vmin[y];\n\t\t\t\tp2 = x + vmax[y];\n\n\t\t\t\trsum += r[p1] - r[p2];\n\t\t\t\tgsum += g[p1] - g[p2];\n\t\t\t\tbsum += b[p1] - b[p2];\n\t\t\t\tasum += a[p1] - a[p2];\n\n\t\t\t\tyi += width << 2;\n\t\t\t}\n\t\t}\n\t}\n\t\n\tcontext.putImageData( imageData, top_x, top_y );\n\t\n}\n\nfunction boxBlurCanvasRGB( context, top_x, top_y, width, height, radius, iterations ){\n\tif ( isNaN(radius) || radius < 1 ) return;\n\t\n\tradius |= 0;\n\t\n\tif ( isNaN(iterations) ) iterations = 1;\n\titerations |= 0;\n\tif ( iterations > 3 ) iterations = 3;\n\tif ( iterations < 1 ) iterations = 1;\n\t\n\tvar imageData;\n\t\n\ttry {\n\t\timageData = context.getImageData( top_x, top_y, width, height );\n\t} catch(e) {\n\t  alert(\"Cannot access image\");\n\t  throw new Error(\"unable to access image data: \" + e);\n\t  return;\n\t}\n\t\t\t\n\tvar pixels = imageData.data;\n\t\t\n\tvar rsum,gsum,bsum,asum,x,y,i,p,p1,p2,yp,yi,yw,idx;\t\t\n\tvar wm = width - 1;\n  \tvar hm = height - 1;\n    var wh = width * height;\n\tvar rad1 = radius + 1;\n   \n\tvar r = [];\n    var g = [];\n    var b = [];\n\t\n\tvar mul_sum = mul_table[radius];\n\tvar shg_sum = shg_table[radius];\n\t\n\tvar vmin = [];\n\tvar vmax = [];\n  \n\twhile ( iterations-- > 0 ){\n\t\tyw = yi = 0;\n\t \n\t\tfor ( y=0; y < height; y++ ){\n\t\t\trsum = pixels[yw]   * rad1;\n\t\t\tgsum = pixels[yw+1] * rad1;\n\t\t\tbsum = pixels[yw+2] * rad1;\n\t\t\t\n\t\t\tfor( i = 1; i <= radius; i++ ){\n\t\t\t\tp = yw + (((i > wm ? wm : i )) << 2 );\n\t\t\t\trsum += pixels[p++];\n\t\t\t\tgsum += pixels[p++];\n\t\t\t\tbsum += pixels[p++];\n\t\t\t}\n\t\t\t\n\t\t\tfor ( x = 0; x < width; x++ ){\n\t\t\t\tr[yi] = rsum;\n\t\t\t\tg[yi] = gsum;\n\t\t\t\tb[yi] = bsum;\n\t\t\t\t\n\t\t\t\tif( y==0) {\n\t\t\t\t\tvmin[x] = ( ( p = x + rad1) < wm ? p : wm ) << 2;\n\t\t\t\t\tvmax[x] = ( ( p = x - radius) > 0 ? p << 2 : 0 );\n\t\t\t\t} \n\t\t\t\t\n\t\t\t\tp1 = yw + vmin[x];\n\t\t\t\tp2 = yw + vmax[x];\n\t\t\t\t  \n\t\t\t\trsum += pixels[p1++] - pixels[p2++];\n\t\t\t\tgsum += pixels[p1++] - pixels[p2++];\n\t\t\t\tbsum += pixels[p1++] - pixels[p2++];\n\t\t\t\t \n\t\t\t\tyi++;\n\t\t\t}\n\t\t\tyw += ( width << 2 );\n\t\t}\n\t  \n\t\tfor ( x = 0; x < width; x++ ){\n\t\t\typ = x;\n\t\t\trsum = r[yp] * rad1;\n\t\t\tgsum = g[yp] * rad1;\n\t\t\tbsum = b[yp] * rad1;\n\t\t\t\t\n\t\t\tfor( i = 1; i <= radius; i++ ){\n\t\t\t  yp += ( i > hm ? 0 : width );\n\t\t\t  rsum += r[yp];\n\t\t\t  gsum += g[yp];\n\t\t\t  bsum += b[yp];\n\t\t\t}\n\t\t\t\n\t\t\tyi = x << 2;\n\t\t\tfor ( y = 0; y < height; y++){\n\t\t\t\tpixels[yi]   = (rsum * mul_sum) >>> shg_sum;\n\t\t\t\tpixels[yi+1] = (gsum * mul_sum) >>> shg_sum;\n\t\t\t\tpixels[yi+2] = (bsum * mul_sum) >>> shg_sum;\n\t\t   \n\t\t\t\tif( x == 0 ) {\n\t\t\t\t\tvmin[y] = ( ( p = y + rad1) < hm ? p : hm ) * width;\n\t\t\t\t\tvmax[y] = ( ( p = y - radius) > 0 ? p * width : 0 );\n\t\t\t\t} \n\t\t\t\t  \n\t\t\t\tp1 = x + vmin[y];\n\t\t\t\tp2 = x + vmax[y];\n\n\t\t\t\trsum += r[p1] - r[p2];\n\t\t\t\tgsum += g[p1] - g[p2];\n\t\t\t\tbsum += b[p1] - b[p2];\n\t\t\t\t  \n\t\t\t\tyi += width << 2;\n\t\t\t}\n\t\t}\n\t}\n\tcontext.putImageData( imageData, top_x, top_y );\n\t\n}\n","import { type CanvasRenderingContext2D, createCanvas, ImageData } from \"canvas\";\nimport * as fabric from \"fabric/node\";\nimport { boxBlurImage } from \"../BoxBlur.js\";\nimport { defineFrameSource } from \"../api/index.js\";\nimport type { FabricLayer } from \"../types.js\";\n\n// Fabric is used as a fundament for compositing layers in editly\n\nexport function canvasToRgba(ctx: CanvasRenderingContext2D) {\n  // We cannot use toBuffer('raw') because it returns pre-multiplied alpha data (a different format)\n  // https://gamedev.stackexchange.com/questions/138813/whats-the-difference-between-alpha-and-premulalpha\n  // https://github.com/Automattic/node-canvas#image-pixel-formats-experimental\n  const imageData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);\n  return Buffer.from(imageData.data);\n}\n\nexport function fabricCanvasToRgba(fabricCanvas: fabric.StaticCanvas) {\n  const internalCanvas = fabricCanvas.getNodeCanvas();\n  const ctx = internalCanvas.getContext(\"2d\");\n\n  return canvasToRgba(ctx);\n}\n\nexport function createFabricCanvas({ width, height }: { width: number; height: number }) {\n  return new fabric.StaticCanvas(null, { width, height });\n}\n\nexport async function renderFabricCanvas(canvas: fabric.StaticCanvas) {\n  // console.time('canvas.renderAll');\n  canvas.renderAll();\n  // console.timeEnd('canvas.renderAll');\n  const rgba = fabricCanvasToRgba(canvas);\n  canvas.clear();\n  canvas.dispose();\n  return rgba;\n}\n\nexport function toUint8ClampedArray(buffer: Buffer) {\n  // return Uint8ClampedArray.from(buffer);\n  // Some people are finding that manual copying is orders of magnitude faster than Uint8ClampedArray.from\n  // Since I'm getting similar times for both methods, then why not:\n  const data = new Uint8ClampedArray(buffer.length);\n  for (let i = 0; i < buffer.length; i += 1) {\n    data[i] = buffer[i];\n  }\n  return data;\n}\n\nexport async function rgbaToFabricImage({\n  width,\n  height,\n  rgba,\n}: {\n  width: number;\n  height: number;\n  rgba: Buffer;\n}) {\n  const canvas = createCanvas(width, height);\n\n  // FIXME: Fabric tries to add a class to this, but DOM is not defined. Because node?\n  // https://github.com/fabricjs/fabric.js/issues/10032\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  (canvas as any).classList = new Set();\n\n  const ctx = canvas.getContext(\"2d\");\n  // https://developer.mozilla.org/en-US/docs/Web/API/ImageData/ImageData\n  // https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/putImageData\n  ctx.putImageData(new ImageData(toUint8ClampedArray(rgba), width, height), 0, 0);\n  // https://stackoverflow.com/questions/58209996/unable-to-render-tiff-images-and-add-it-as-a-fabric-object\n  return new fabric.FabricImage(canvas);\n}\n\nexport type BlurImageOptions = {\n  mutableImg: fabric.FabricImage;\n  width: number;\n  height: number;\n};\n\nexport async function blurImage({ mutableImg, width, height }: BlurImageOptions) {\n  mutableImg.set({ scaleX: width / mutableImg.width, scaleY: height / mutableImg.height });\n\n  const canvas = mutableImg.toCanvasElement();\n  const ctx = canvas.getContext(\"2d\");\n\n  const blurAmount = Math.min(100, Math.max(width, height) / 10); // More than 100 seems to cause issues\n  const passes = 1;\n  boxBlurImage(ctx, width, height, blurAmount, false, passes);\n\n  return new fabric.FabricImage(canvas);\n} // http://fabricjs.com/kitchensink\n\nexport default defineFrameSource<FabricLayer>(\"fabric\", async ({ width, height, params }) => {\n  const { onRender, onClose } = await params.func({ width, height, fabric, params });\n\n  return {\n    readNextFrame: onRender,\n    close: onClose,\n  };\n});\n","import { createCanvas } from \"canvas\";\nimport { defineFrameSource } from \"../api/index.js\";\nimport type { CanvasLayer } from \"../types.js\";\nimport { canvasToRgba } from \"./fabric.js\";\n\nexport default defineFrameSource<CanvasLayer>(\"canvas\", async ({ width, height, params }) => {\n  const canvas = createCanvas(width, height);\n  const context = canvas.getContext(\"2d\");\n\n  const { onClose, onRender } = await params.func({ width, height, canvas });\n\n  async function readNextFrame(progress: number) {\n    context.clearRect(0, 0, canvas.width, canvas.height);\n    await onRender(progress);\n    // require('fs').writeFileSync(`${new Date().getTime()}.png`, canvas.toBuffer('image/png'));\n    // I don't know any way to draw a node-canvas as a layer on a fabric.js canvas, other than converting to rgba first:\n    return canvasToRgba(context);\n  }\n\n  return {\n    readNextFrame,\n    // Node canvas needs no cleanup https://github.com/Automattic/node-canvas/issues/1216#issuecomment-412390668\n    close: onClose,\n  };\n});\n","// TODO make separate npm module\n\n// https://stackoverflow.com/a/4382138/6519037\nconst allColors = [\n  \"hsl(42, 100%, 50%)\",\n  \"hsl(310, 34%, 37%)\",\n  \"hsl(24, 100%, 50%)\",\n  \"hsl(211, 38%, 74%)\",\n  \"hsl(350, 100%, 37%)\",\n  \"hsl(35, 52%, 59%)\",\n  \"hsl(22, 11%, 45%)\",\n  \"hsl(145, 100%, 24%)\",\n  \"hsl(348, 87%, 71%)\",\n  \"hsl(203, 100%, 27%)\",\n  \"hsl(11, 100%, 68%)\",\n  \"hsl(265, 37%, 34%)\",\n  \"hsl(33, 100%, 50%)\",\n  \"hsl(342, 63%, 42%)\",\n  \"hsl(49, 100%, 47%)\",\n  \"hsl(5, 81%, 27%)\",\n  \"hsl(68, 100%, 33%)\",\n  \"hsl(26, 61%, 21%)\",\n  \"hsl(10, 88%, 51%)\",\n  \"hsl(84, 33%, 12%)\",\n];\n\n// https://digitalsynopsis.com/design/beautiful-color-ui-gradients-backgrounds/\nconst gradientColors = [\n  [\"#ff9aac\", \"#ffa875\"],\n  [\"#cc2b5e\", \"#753a88\"],\n  [\"#42275a\", \"#734b6d\"],\n  [\"#bdc3c7\", \"#2c3e50\"],\n  [\"#de6262\", \"#ffb88c\"],\n  [\"#eb3349\", \"#f45c43\"],\n  [\"#dd5e89\", \"#f7bb97\"],\n  [\"#56ab2f\", \"#a8e063\"],\n  [\"#614385\", \"#516395\"],\n  [\"#eecda3\", \"#ef629f\"],\n  [\"#eacda3\", \"#d6ae7b\"],\n  [\"#02aab0\", \"#00cdac\"],\n  [\"#d66d75\", \"#e29587\"],\n  [\"#000428\", \"#004e92\"],\n  [\"#ddd6f3\", \"#faaca8\"],\n  [\"#7b4397\", \"#dc2430\"],\n  [\"#43cea2\", \"#185a9d\"],\n  [\"#ba5370\", \"#f4e2d8\"],\n  [\"#ff512f\", \"#dd2476\"],\n  [\"#4568dc\", \"#b06ab3\"],\n  [\"#ec6f66\", \"#f3a183\"],\n  [\"#ffd89b\", \"#19547b\"],\n  [\"#3a1c71\", \"#d76d77\"],\n  [\"#4ca1af\", \"#c4e0e5\"],\n  [\"#ff5f6d\", \"#ffc371\"],\n  [\"#36d1dc\", \"#5b86e5\"],\n  [\"#c33764\", \"#1d2671\"],\n  [\"#141e30\", \"#243b55\"],\n  [\"#ff7e5f\", \"#feb47b\"],\n  [\"#ed4264\", \"#ffedbc\"],\n  [\"#2b5876\", \"#4e4376\"],\n  [\"#ff9966\", \"#ff5e62\"],\n  [\"#aa076b\", \"#61045f\"],\n];\n\n/* const lightGradients = [\n  [\n    '#ee9ca7',\n    '#ffdde1',\n  ],\n  [\n    '#2193b0',\n    '#6dd5ed',\n  ],\n]; */\n\nexport function getRandomColor(colors = allColors) {\n  const index = Math.floor(Math.random() * colors.length);\n  const remainingColors = [...colors];\n  remainingColors.splice(index, 1);\n  return { remainingColors, color: colors[index] || allColors[0] };\n}\n\nexport function getRandomColors(num: number) {\n  let colors = allColors;\n  const out = [];\n  for (let i = 0; i < Math.min(num, allColors.length); i += 1) {\n    const { remainingColors, color } = getRandomColor(colors);\n    out.push(color);\n    colors = remainingColors;\n  }\n  return out;\n}\n\nexport function getRandomGradient() {\n  return gradientColors[Math.floor(Math.random() * gradientColors.length)];\n}\n","import { Rect } from \"fabric/node\";\nimport { defineFrameSource } from \"../api/index.js\";\nimport { getRandomColors } from \"../colors.js\";\nimport type { FillColorLayer } from \"../types.js\";\n\nexport default defineFrameSource<FillColorLayer>(\n  \"fill-color\",\n  async ({ params, width, height }) => {\n    const { color } = params;\n\n    const randomColor = getRandomColors(1)[0];\n\n    return {\n      async readNextFrame(_, canvas) {\n        const rect = new Rect({\n          left: 0,\n          right: 0,\n          width,\n          height,\n          fill: color || randomColor,\n        });\n        canvas.add(rect);\n      },\n    };\n  },\n);\n","import GL from \"gl\";\nimport createShader from \"gl-shader\";\nimport { readFile } from \"node:fs/promises\";\nimport { defineFrameSource } from \"../api/index.js\";\nimport type { GlLayer } from \"../types.js\";\n\n// I have no idea what I'm doing but it works ¯\\_(ツ)_/¯\n\nexport default defineFrameSource<GlLayer>(\"gl\", async ({ width, height, channels, params }) => {\n  const gl = GL(width, height);\n\n  const defaultVertexSrc = `\n    attribute vec2 position;\n    void main(void) {\n      gl_Position = vec4(position, 0.0, 1.0 );\n    }\n  `;\n  const {\n    vertexPath,\n    fragmentPath,\n    vertexSrc: vertexSrcIn,\n    fragmentSrc: fragmentSrcIn,\n    speed = 1,\n  } = params;\n\n  let fragmentSrc = fragmentSrcIn;\n  let vertexSrc = vertexSrcIn;\n\n  if (fragmentPath) fragmentSrc = (await readFile(fragmentPath)).toString();\n  if (vertexPath) vertexSrc = (await readFile(vertexPath)).toString();\n\n  if (!vertexSrc) vertexSrc = defaultVertexSrc;\n\n  const shader = createShader(gl, vertexSrc, fragmentSrc ?? \"\");\n  const buffer = gl.createBuffer();\n  gl.bindBuffer(gl.ARRAY_BUFFER, buffer);\n  // https://blog.mayflower.de/4584-Playing-around-with-pixel-shaders-in-WebGL.html\n\n  gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1, -1, 1, -1, 1, 1, -1, 1]), gl.STATIC_DRAW);\n\n  async function readNextFrame(progress: number) {\n    shader.bind();\n\n    shader.attributes.position.pointer();\n\n    shader.uniforms.resolution = [width, height];\n    shader.uniforms.time = progress * speed;\n\n    gl.drawArrays(gl.TRIANGLE_FAN, 0, 4);\n\n    const upsideDownArray = Buffer.allocUnsafe(width * height * channels);\n    gl.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, upsideDownArray);\n    const outArray = Buffer.allocUnsafe(width * height * channels);\n\n    // Comes out upside down, flip it\n    for (let i = 0; i < outArray.length; i += 4) {\n      outArray[i + 0] = upsideDownArray[outArray.length - i + 0];\n      outArray[i + 1] = upsideDownArray[outArray.length - i + 1];\n      outArray[i + 2] = upsideDownArray[outArray.length - i + 2];\n      outArray[i + 3] = upsideDownArray[outArray.length - i + 3];\n    }\n    return outArray;\n  }\n\n  return {\n    readNextFrame,\n  };\n});\n","import assert from \"assert\";\nimport type { TOriginX, TOriginY } from \"fabric\";\nimport * as fabric from \"fabric/node\";\nimport fileUrl from \"file-url\";\nimport { pathExists } from \"fs-extra\";\nimport { sortBy } from \"lodash-es\";\nimport type { KenBurns, Keyframe, Position, PositionObject } from \"./types.js\";\n\nexport function toArrayInteger(buffer: Buffer) {\n  if (buffer.length > 0) {\n    const data = new Uint8ClampedArray(buffer.length);\n    for (let i = 0; i < buffer.length; i += 1) {\n      data[i] = buffer[i];\n    }\n    return data;\n  }\n  return [];\n}\n\n// x264 requires multiple of 2\nexport const multipleOf2 = (x: number) => Math.round(x / 2) * 2;\n\nexport function getPositionProps({\n  position,\n  width,\n  height,\n}: {\n  position?: Position | PositionObject;\n  width: number;\n  height: number;\n}) {\n  let originY: TOriginY = \"center\";\n  let originX: TOriginX = \"center\";\n  let top = height / 2;\n  let left = width / 2;\n  const margin = 0.05;\n\n  if (typeof position === \"string\") {\n    if (position === \"top\") {\n      originY = \"top\";\n      top = height * margin;\n    } else if (position === \"bottom\") {\n      originY = \"bottom\";\n      top = height * (1 - margin);\n    } else if (position === \"center\") {\n      originY = \"center\";\n      top = height / 2;\n    } else if (position === \"top-left\") {\n      originX = \"left\";\n      originY = \"top\";\n      left = width * margin;\n      top = height * margin;\n    } else if (position === \"top-right\") {\n      originX = \"right\";\n      originY = \"top\";\n      left = width * (1 - margin);\n      top = height * margin;\n    } else if (position === \"center-left\") {\n      originX = \"left\";\n      originY = \"center\";\n      left = width * margin;\n      top = height / 2;\n    } else if (position === \"center-right\") {\n      originX = \"right\";\n      originY = \"center\";\n      left = width * (1 - margin);\n      top = height / 2;\n    } else if (position === \"bottom-left\") {\n      originX = \"left\";\n      originY = \"bottom\";\n      left = width * margin;\n      top = height * (1 - margin);\n    } else if (position === \"bottom-right\") {\n      originX = \"right\";\n      originY = \"bottom\";\n      left = width * (1 - margin);\n      top = height * (1 - margin);\n    }\n  } else {\n    if (position?.x != null) {\n      originX = position.originX || \"left\";\n      left = width * position.x;\n    }\n    if (position?.y != null) {\n      originY = position.originY || \"top\";\n      top = height * position.y;\n    }\n  }\n\n  return { originX, originY, top, left };\n}\n\nexport function getFrameByKeyFrames(keyframes: Keyframe[], progress: number) {\n  if (keyframes.length < 2) throw new Error(\"Keyframes must be at least 2\");\n  const sortedKeyframes = sortBy(keyframes, \"t\");\n\n  // TODO check that max is 1\n  // TODO check that all keyframes have all props\n  // TODO make smarter so user doesn't need to replicate non-changing props\n\n  const invalidKeyframe = sortedKeyframes.find((k, i) => {\n    if (i === 0) return false;\n    return k.t === sortedKeyframes[i - 1].t;\n  });\n  if (invalidKeyframe) throw new Error(\"Invalid keyframe\");\n\n  let prevKeyframe = [...sortedKeyframes].reverse().find((k) => k.t < progress);\n  if (!prevKeyframe) prevKeyframe = sortedKeyframes[0];\n\n  let nextKeyframe = sortedKeyframes.find((k) => k.t >= progress);\n  if (!nextKeyframe) nextKeyframe = sortedKeyframes[sortedKeyframes.length - 1];\n\n  if (nextKeyframe.t === prevKeyframe.t) return prevKeyframe.props;\n\n  const interProgress = (progress - prevKeyframe.t) / (nextKeyframe.t - prevKeyframe.t);\n  return Object.fromEntries(\n    Object.entries(prevKeyframe.props).map(([propName, prevVal]) => [\n      propName,\n      prevVal + (nextKeyframe.props[propName] - prevVal) * interProgress,\n    ]),\n  );\n}\n\nexport const isUrl = (path: string) => /^https?:\\/\\//.test(path);\n\nexport const assertFileValid = async (path: string, allowRemoteRequests?: boolean) => {\n  if (isUrl(path)) {\n    assert(allowRemoteRequests, \"Remote requests are not allowed\");\n    return;\n  }\n  assert(await pathExists(path), `File does not exist ${path}`);\n};\n\nexport const loadImage = (pathOrUrl: string) =>\n  fabric.util.loadImage(isUrl(pathOrUrl) ? pathOrUrl : fileUrl(pathOrUrl));\nexport const defaultFontFamily = \"sans-serif\";\n\nexport function getZoomParams({\n  progress,\n  zoomDirection,\n  zoomAmount = 0.1,\n}: KenBurns & { progress: number }) {\n  let scaleFactor = 1;\n  if (zoomDirection === \"left\" || zoomDirection === \"right\") return 1.3 + zoomAmount;\n  if (zoomDirection === \"in\") scaleFactor = 1 + zoomAmount * progress;\n  else if (zoomDirection === \"out\") scaleFactor = 1 + zoomAmount * (1 - progress);\n  return scaleFactor;\n}\n\nexport function getTranslationParams({\n  progress,\n  zoomDirection,\n  zoomAmount = 0.1,\n}: KenBurns & { progress: number }) {\n  let translation = 0;\n  const range = zoomAmount * 1000;\n\n  if (zoomDirection === \"right\") translation = progress * range - range / 2;\n  else if (zoomDirection === \"left\") translation = -(progress * range - range / 2);\n\n  return translation;\n}\n\nexport function getRekt(width: number, height: number) {\n  // width and height with room to rotate\n  return new fabric.Rect({\n    originX: \"center\",\n    originY: \"center\",\n    left: width / 2,\n    top: height / 2,\n    width: width * 2,\n    height: height * 2,\n  });\n}\n","import * as fabric from \"fabric/node\";\nimport { defineFrameSource } from \"../api/index.js\";\nimport type { ImageOverlayLayer } from \"../types.js\";\nimport { getPositionProps, getTranslationParams, getZoomParams, loadImage } from \"../util.js\";\n\nexport default defineFrameSource<ImageOverlayLayer>(\n  \"image-overlay\",\n  async ({ params, width, height }) => {\n    const {\n      path,\n      position,\n      width: relWidth,\n      height: relHeight,\n      zoomDirection,\n      zoomAmount = 0.1,\n    } = params;\n\n    const imgData = await loadImage(path);\n\n    const img = new fabric.FabricImage(imgData, getPositionProps({ position, width, height }));\n\n    return {\n      async readNextFrame(progress, canvas) {\n        const scaleFactor = getZoomParams({ progress, zoomDirection, zoomAmount });\n\n        const translationParams = getTranslationParams({ progress, zoomDirection, zoomAmount });\n        img.left = width / 2 + translationParams;\n\n        if (relWidth != null) {\n          img.scaleToWidth(relWidth * width * scaleFactor);\n        } else if (relHeight != null) {\n          img.scaleToHeight(relHeight * height * scaleFactor);\n        } else {\n          // Default to screen width\n          img.scaleToWidth(width * scaleFactor);\n        }\n\n        canvas.add(img);\n      },\n    };\n  },\n);\n","import { FabricImage } from \"fabric/node\";\nimport { defineFrameSource } from \"../api/index.js\";\nimport type { ImageLayer } from \"../types.js\";\nimport { getTranslationParams, getZoomParams, loadImage } from \"../util.js\";\nimport { blurImage } from \"./fabric.js\";\n\nexport default defineFrameSource<ImageLayer>(\n  \"image\",\n  async ({ verbose, params, width, height }) => {\n    const { path, zoomDirection = \"in\", zoomAmount = 0.1, resizeMode = \"contain-blur\" } = params;\n\n    if (verbose) console.log(\"Loading\", path);\n\n    const imgData = await loadImage(path);\n\n    const createImg = () =>\n      new FabricImage(imgData, {\n        originX: \"center\",\n        originY: \"center\",\n        left: width / 2,\n        top: height / 2,\n      });\n\n    let blurredImg: FabricImage;\n    // Blurred version\n    if (resizeMode === \"contain-blur\") {\n      // If we dispose mutableImg, seems to cause issues with the rendering of blurredImg\n      const mutableImg = createImg();\n      if (verbose) console.log(\"Blurring background\");\n      blurredImg = await blurImage({ mutableImg, width, height });\n    }\n\n    return {\n      async readNextFrame(progress, canvas) {\n        const img = createImg();\n\n        const scaleFactor = getZoomParams({ progress, zoomDirection, zoomAmount });\n        const translationParams = getTranslationParams({ progress, zoomDirection, zoomAmount });\n\n        const ratioW = width / img.width;\n        const ratioH = height / img.height;\n\n        img.left = width / 2 + translationParams;\n\n        if ([\"contain\", \"contain-blur\"].includes(resizeMode)) {\n          if (ratioW > ratioH) {\n            img.scaleToHeight(height * scaleFactor);\n          } else {\n            img.scaleToWidth(width * scaleFactor);\n          }\n        } else if (resizeMode === \"cover\") {\n          if (ratioW > ratioH) {\n            img.scaleToWidth(width * scaleFactor);\n          } else {\n            img.scaleToHeight(height * scaleFactor);\n          }\n        } else if (resizeMode === \"stretch\") {\n          img.set({\n            scaleX: (width / img.width) * scaleFactor,\n            scaleY: (height / img.height) * scaleFactor,\n          });\n        }\n\n        if (blurredImg) canvas.add(blurredImg);\n        canvas.add(img);\n      },\n\n      close() {\n        if (blurredImg) blurredImg.dispose();\n        // imgData.dispose();\n      },\n    };\n  },\n);\n","import { Gradient } from \"fabric/node\";\nimport { defineFrameSource } from \"../api/index.js\";\nimport { getRandomGradient } from \"../colors.js\";\nimport type { LinearGradientLayer } from \"../types.js\";\nimport { getRekt } from \"../util.js\";\n\nexport default defineFrameSource<LinearGradientLayer>(\n  \"linear-gradient\",\n  async ({ width, height, params }) => {\n    const { colors: inColors } = params;\n    const colors = inColors && inColors.length === 2 ? inColors : getRandomGradient();\n\n    return {\n      async readNextFrame(progress, canvas) {\n        const rect = getRekt(width, height);\n\n        rect.set(\n          \"fill\",\n          new Gradient({\n            coords: {\n              x1: 0,\n              y1: 0,\n              x2: width,\n              y2: height,\n            },\n            colorStops: [\n              { offset: 0, color: colors[0] },\n              { offset: 1, color: colors[1] },\n            ],\n          }),\n        );\n\n        rect.rotate(progress * 30);\n        canvas.add(rect);\n      },\n    };\n  },\n);\n","// https://easings.net/\n\nexport type EasingFunction = (progress: number) => number;\n\nexport const easeOutExpo: EasingFunction = (x: number) => (x === 1 ? 1 : 1 - 2 ** (-10 * x));\nexport const easeInOutCubic: EasingFunction = (x: number) =>\n  x < 0.5 ? 4 * x * x * x : 1 - (-2 * x + 2) ** 3 / 2;\nexport const linear: EasingFunction = (x: number) => x;\n","import { FabricText, Rect } from \"fabric/node\";\nimport { defineFrameSource } from \"../api/index.js\";\nimport { easeOutExpo } from \"../easings.js\";\nimport type { NewsTitleLayer } from \"../types.js\";\nimport { defaultFontFamily } from \"../util.js\";\n\nexport default defineFrameSource<NewsTitleLayer>(\n  \"news-title\",\n  async ({ width, height, params }) => {\n    const {\n      text,\n      textColor = \"#ffffff\",\n      backgroundColor = \"#d02a42\",\n      fontFamily = defaultFontFamily,\n      delay = 0,\n      speed = 1,\n    } = params;\n    const min = Math.min(width, height);\n    const fontSize = Math.round(min * 0.05);\n\n    return {\n      async readNextFrame(progress, canvas) {\n        const easedBgProgress = easeOutExpo(\n          Math.max(0, Math.min((progress - delay) * speed * 3, 1)),\n        );\n        const easedTextProgress = easeOutExpo(\n          Math.max(0, Math.min((progress - delay - 0.02) * speed * 4, 1)),\n        );\n        const easedTextOpacityProgress = easeOutExpo(\n          Math.max(0, Math.min((progress - delay - 0.07) * speed * 4, 1)),\n        );\n\n        const top = height * 0.08;\n\n        const paddingV = 0.07 * min;\n        const paddingH = 0.03 * min;\n\n        const textBox = new FabricText(text, {\n          top,\n          left: paddingV + (easedTextProgress - 1) * width,\n          fill: textColor,\n          opacity: easedTextOpacityProgress,\n          fontFamily,\n          fontSize,\n          charSpacing: width * 0.1,\n        });\n\n        const bgWidth = textBox.width + paddingV * 2;\n        const rect = new Rect({\n          top: top - paddingH,\n          left: (easedBgProgress - 1) * bgWidth,\n          width: bgWidth,\n          height: textBox.height + paddingH * 2,\n          fill: backgroundColor,\n        });\n\n        canvas.add(rect);\n        canvas.add(textBox);\n      },\n    };\n  },\n);\n","import * as fabric from \"fabric/node\";\nimport { defineFrameSource } from \"../api/index.js\";\nimport { getRandomGradient } from \"../colors.js\";\nimport type { RadialGradientLayer } from \"../types.js\";\nimport { getRekt } from \"../util.js\";\n\nexport default defineFrameSource<RadialGradientLayer>(\n  \"radial-gradient\",\n  async ({ width, height, params }) => {\n    const { colors: inColors } = params;\n\n    const colors = inColors && inColors.length === 2 ? inColors : getRandomGradient();\n\n    return {\n      async readNextFrame(progress, canvas) {\n        // console.log('progress', progress);\n        const max = Math.max(width, height);\n\n        const r1 = 0;\n        const r2 = max * (1 + progress) * 0.6;\n\n        const rect = getRekt(width, height);\n\n        const cx = 0.5 * rect.width;\n        const cy = 0.5 * rect.height;\n\n        rect.set(\n          \"fill\",\n          new fabric.Gradient({\n            type: \"radial\",\n            coords: {\n              r1,\n              r2,\n              x1: cx,\n              y1: cy,\n              x2: cx,\n              y2: cy,\n            },\n            colorStops: [\n              { offset: 0, color: colors[0] },\n              { offset: 1, color: colors[1] },\n            ],\n          }),\n        );\n\n        canvas.add(rect);\n      },\n    };\n  },\n);\n","import * as fabric from \"fabric/node\";\nimport { defineFrameSource } from \"../api/index.js\";\nimport { easeInOutCubic } from \"../easings.js\";\nimport type { SlideInTextLayer } from \"../types.js\";\nimport { defaultFontFamily, getFrameByKeyFrames, getPositionProps } from \"../util.js\";\n\nexport default defineFrameSource<SlideInTextLayer>(\n  \"slide-in-text\",\n  async ({ width, height, params }) => {\n    const {\n      position,\n      text,\n      fontSize = 0.05,\n      charSpacing = 0.1,\n      textColor = \"#ffffff\",\n      color = undefined,\n      fontFamily = defaultFontFamily,\n    } = params;\n\n    if (color) {\n      console.warn(\"slide-in-text: color is deprecated, use textColor.\");\n    }\n\n    const fontSizeAbs = Math.round(width * fontSize);\n\n    const { left, top, originX, originY } = getPositionProps({ position, width, height });\n\n    return {\n      async readNextFrame(progress, canvas) {\n        const textBox = new fabric.FabricText(text, {\n          fill: color ?? textColor,\n          fontFamily,\n          fontSize: fontSizeAbs,\n          charSpacing: width * charSpacing,\n        });\n\n        const { opacity, textSlide } = getFrameByKeyFrames(\n          [\n            { t: 0.1, props: { opacity: 1, textSlide: 0 } },\n            { t: 0.3, props: { opacity: 1, textSlide: 1 } },\n            { t: 0.8, props: { opacity: 1, textSlide: 1 } },\n            { t: 0.9, props: { opacity: 0, textSlide: 1 } },\n          ],\n          progress,\n        );\n\n        const fadedObject = await getFadedObject({\n          object: textBox,\n          progress: easeInOutCubic(textSlide),\n        });\n        fadedObject.set({\n          originX,\n          originY,\n          top,\n          left,\n          opacity,\n        });\n\n        canvas.add(fadedObject);\n      },\n    };\n  },\n);\n\nasync function getFadedObject<T extends fabric.FabricObject>({\n  object,\n  progress,\n}: {\n  object: T;\n  progress: number;\n}) {\n  const rect = new fabric.Rect({\n    left: 0,\n    width: object.width,\n    height: object.height,\n    top: 0,\n  });\n\n  rect.set(\n    \"fill\",\n    new fabric.Gradient({\n      coords: {\n        x1: 0,\n        y1: 0,\n        x2: object.width,\n        y2: 0,\n      },\n      colorStops: [\n        { offset: Math.max(0, progress * (1 + 0.2) - 0.2), color: \"rgba(255,255,255,1)\" },\n        { offset: Math.min(1, progress * (1 + 0.2)), color: \"rgba(255,255,255,0)\" },\n      ],\n    }),\n  );\n\n  const gradientMaskImg = rect.cloneAsImage({});\n  const fadedImage = object.cloneAsImage({});\n\n  fadedImage.filters.push(\n    new fabric.filters.BlendImage({\n      image: gradientMaskImg,\n      mode: \"multiply\",\n    }),\n  );\n\n  fadedImage.applyFilters();\n\n  return fadedImage;\n}\n","import { Rect, Textbox } from \"fabric/node\";\nimport { defineFrameSource } from \"../api/index.js\";\nimport { easeOutExpo } from \"../easings.js\";\nimport type { SubtitleLayer } from \"../types.js\";\nimport { defaultFontFamily } from \"../util.js\";\n\nexport default defineFrameSource<SubtitleLayer>(\"subtitle\", async ({ width, height, params }) => {\n  const {\n    text,\n    textColor = \"#ffffff\",\n    backgroundColor = \"rgba(0,0,0,0.3)\",\n    fontFamily = defaultFontFamily,\n    delay = 0,\n    speed = 1,\n  } = params;\n\n  return {\n    async readNextFrame(progress, canvas) {\n      const easedProgress = easeOutExpo(Math.max(0, Math.min((progress - delay) * speed, 1)));\n\n      const min = Math.min(width, height);\n      const padding = 0.05 * min;\n\n      const textBox = new Textbox(text, {\n        fill: textColor,\n        fontFamily,\n\n        fontSize: min / 20,\n        textAlign: \"left\",\n        width: width - padding * 2,\n        originX: \"center\",\n        originY: \"bottom\",\n        left: width / 2 + (-1 + easedProgress) * padding,\n        top: height - padding,\n        opacity: easedProgress,\n      });\n\n      const rect = new Rect({\n        left: 0,\n        width,\n        height: textBox.height + padding * 2,\n        top: height,\n        originY: \"bottom\",\n        fill: backgroundColor,\n        opacity: easedProgress,\n      });\n\n      canvas.add(rect);\n      canvas.add(textBox);\n    },\n  };\n});\n","import { Textbox } from \"fabric/node\";\nimport { defineFrameSource } from \"../api//index.js\";\nimport type { TitleLayer } from \"../types.js\";\nimport {\n  defaultFontFamily,\n  getPositionProps,\n  getTranslationParams,\n  getZoomParams,\n} from \"../util.js\";\n\nexport default defineFrameSource<TitleLayer>(\"title\", async ({ width, height, params }) => {\n  const {\n    text,\n    textColor = \"#ffffff\",\n    fontFamily = defaultFontFamily,\n    position = \"center\",\n    zoomDirection = \"in\",\n    zoomAmount = 0.2,\n  } = params;\n  const fontSize = Math.round(Math.min(width, height) * 0.1);\n\n  const textBox = new Textbox(text, {\n    fill: textColor,\n    fontFamily,\n    fontSize,\n    textAlign: \"center\",\n    width: width * 0.8,\n  });\n\n  return {\n    async readNextFrame(progress, canvas) {\n      const scaleFactor = getZoomParams({ progress, zoomDirection, zoomAmount });\n      const translationParams = getTranslationParams({ progress, zoomDirection, zoomAmount });\n\n      // We need the text as an image in order to scale it\n      const textImage = textBox.cloneAsImage({});\n\n      const { left, top, originX, originY } = getPositionProps({ position, width, height });\n\n      textImage.set({\n        originX,\n        originY,\n        left: left + translationParams,\n        top,\n        scaleX: scaleFactor,\n        scaleY: scaleFactor,\n      });\n\n      canvas.add(textImage);\n    },\n  };\n});\n","import { Transform, TransformCallback, TransformOptions } from \"stream\";\n\nexport interface RawVideoToFramesOptions extends Omit<TransformOptions, \"transform\"> {\n  width: number;\n  height: number;\n  channels: number;\n}\n\n/**\n * Transforms a raw video stream into individual frames.\n */\nexport function rawVideoToFrames({ width, height, channels, ...options }: RawVideoToFramesOptions) {\n  const frameByteSize = width * height * channels;\n  let buffer = new Uint8Array(frameByteSize);\n  let bytesRead = 0;\n\n  return new Transform({\n    ...options,\n    writableObjectMode: false,\n    readableObjectMode: true,\n    transform(chunk: Uint8Array, _: BufferEncoding, callback: TransformCallback) {\n      let startAt = 0;\n\n      // Find frames in chunk\n      while (startAt < chunk.length) {\n        const endAt = Math.min(startAt + frameByteSize - bytesRead, chunk.length);\n        const bytesToRead = endAt - startAt;\n        buffer.set(chunk.slice(startAt, endAt), bytesRead);\n        bytesRead = (bytesRead + bytesToRead) % frameByteSize;\n\n        if (bytesRead === 0) {\n          // Emit frame\n          this.push(buffer);\n\n          // Reset data buffer\n          buffer = new Uint8Array(frameByteSize);\n        }\n\n        // Move to next frame\n        startAt = endAt;\n      }\n\n      callback();\n    },\n  });\n}\n","import { ExecaError } from \"execa\";\nimport * as fabric from \"fabric/node\";\nimport { defineFrameSource } from \"../api/index.js\";\nimport { ffmpeg, readFileStreams } from \"../ffmpeg.js\";\nimport { rawVideoToFrames } from \"../transforms/rawVideoToFrames.js\";\nimport type { VideoLayer } from \"../types.js\";\nimport { blurImage, rgbaToFabricImage } from \"./fabric.js\";\n\nexport default defineFrameSource<VideoLayer>(\"video\", async (options) => {\n  const {\n    width: canvasWidth,\n    height: canvasHeight,\n    channels,\n    framerateStr,\n    verbose,\n    logTimes,\n    params,\n  } = options;\n\n  const {\n    path,\n    cutFrom,\n    cutTo,\n    resizeMode = \"contain-blur\",\n    speedFactor,\n    inputWidth,\n    inputHeight,\n    width: requestedWidthRel,\n    height: requestedHeightRel,\n    left: leftRel = 0,\n    top: topRel = 0,\n    originX = \"left\",\n    originY = \"top\",\n    fabricImagePostProcessing = null,\n  } = params;\n\n  const requestedWidth = requestedWidthRel\n    ? Math.round(requestedWidthRel * canvasWidth)\n    : canvasWidth;\n  const requestedHeight = requestedHeightRel\n    ? Math.round(requestedHeightRel * canvasHeight)\n    : canvasHeight;\n\n  const left = leftRel * canvasWidth;\n  const top = topRel * canvasHeight;\n\n  const ratioW = requestedWidth / inputWidth!;\n  const ratioH = requestedHeight / inputHeight!;\n  const inputAspectRatio = inputWidth! / inputHeight!;\n\n  let targetWidth = requestedWidth;\n  let targetHeight = requestedHeight;\n\n  let scaleFilter;\n  if ([\"contain\", \"contain-blur\"].includes(resizeMode)) {\n    if (ratioW > ratioH) {\n      targetHeight = requestedHeight;\n      targetWidth = Math.round(requestedHeight * inputAspectRatio);\n    } else {\n      targetWidth = requestedWidth;\n      targetHeight = Math.round(requestedWidth / inputAspectRatio);\n    }\n\n    scaleFilter = `scale=${targetWidth}:${targetHeight}`;\n  } else if (resizeMode === \"cover\") {\n    let scaledWidth;\n    let scaledHeight;\n\n    if (ratioW > ratioH) {\n      scaledWidth = requestedWidth;\n      scaledHeight = Math.round(requestedWidth / inputAspectRatio);\n    } else {\n      scaledHeight = requestedHeight;\n      scaledWidth = Math.round(requestedHeight * inputAspectRatio);\n    }\n\n    // TODO improve performance by crop first, then scale?\n    scaleFilter = `scale=${scaledWidth}:${scaledHeight},crop=${targetWidth}:${targetHeight}`;\n  } else {\n    // 'stretch'\n    scaleFilter = `scale=${targetWidth}:${targetHeight}`;\n  }\n\n  if (verbose) console.log(scaleFilter);\n\n  let ptsFilter = \"\";\n  if (speedFactor !== 1) {\n    if (verbose) console.log(\"speedFactor\", speedFactor);\n    ptsFilter = `setpts=${speedFactor}*PTS,`;\n  }\n\n  // https://forum.unity.com/threads/settings-for-importing-a-video-with-an-alpha-channel.457657/\n  const streams = await readFileStreams(path);\n  const firstVideoStream = streams.find((s) => s.codec_type === \"video\");\n  // https://superuser.com/a/1116905/658247\n\n  let inputCodec;\n  if (firstVideoStream?.codec_name === \"vp8\") inputCodec = \"libvpx\";\n  else if (firstVideoStream?.codec_name === \"vp9\") inputCodec = \"libvpx-vp9\";\n\n  // http://zulko.github.io/blog/2013/09/27/read-and-write-video-frames-in-python-using-ffmpeg/\n  // Testing: ffmpeg -i 'vid.mov' -t 1 -vcodec rawvideo -pix_fmt rgba -f image2pipe - | ffmpeg -f rawvideo -vcodec rawvideo -pix_fmt rgba -s 2166x1650 -i - -vf format=yuv420p -vcodec libx264 -y out.mp4\n  // https://trac.ffmpeg.org/wiki/ChangingFrameRate\n  const args = [\n    \"-nostdin\",\n    ...(inputCodec ? [\"-vcodec\", inputCodec] : []),\n    ...(cutFrom ? [\"-ss\", cutFrom.toString()] : []),\n    \"-i\",\n    path,\n    ...(cutTo ? [\"-t\", ((cutTo - cutFrom!) * speedFactor!).toString()] : []),\n    \"-vf\",\n    `${ptsFilter}fps=${framerateStr},${scaleFilter}`,\n    \"-map\",\n    \"v:0\",\n    \"-vcodec\",\n    \"rawvideo\",\n    \"-pix_fmt\",\n    \"rgba\",\n    \"-f\",\n    \"image2pipe\",\n    \"-\",\n  ];\n\n  const controller = new AbortController();\n  const transform = rawVideoToFrames({\n    width: targetWidth,\n    height: targetHeight,\n    channels,\n    signal: controller.signal,\n  });\n  const ps = ffmpeg(args, {\n    encoding: \"buffer\",\n    buffer: false,\n    stdin: \"ignore\",\n    stdout: { transform },\n    stderr: process.stderr,\n    // ffmpeg doesn't like to stop, force it\n    forceKillAfterDelay: 1000,\n    cancelSignal: controller.signal,\n  });\n\n  // Ignore errors if the process is aborted\n  ps.catch((err: ExecaError) => {\n    if (!err.isCanceled) throw err;\n    if (verbose) console.log(\"ffmpeg process aborted\", path);\n  });\n\n  // Convert process to iterator to fetch frame data\n  const iterator = ps.iterable();\n\n  async function readNextFrame(progress: number, canvas: fabric.StaticCanvas, time: number) {\n    const { value: rgba, done } = await iterator.next();\n\n    if (done) {\n      if (verbose) console.log(path, \"ffmpeg video stream ended\");\n      return;\n    }\n\n    if (!rgba) {\n      if (verbose) console.log(path, \"No frame data received\");\n      return;\n    }\n\n    if (logTimes) console.time(\"rgbaToFabricImage\");\n    const img = await rgbaToFabricImage({\n      width: targetWidth,\n      height: targetHeight,\n      rgba: Buffer.from(rgba),\n    });\n    if (logTimes) console.timeEnd(\"rgbaToFabricImage\");\n\n    img.set({\n      originX,\n      originY,\n    });\n\n    let centerOffsetX = 0;\n    let centerOffsetY = 0;\n    if (resizeMode === \"contain\" || resizeMode === \"contain-blur\") {\n      const dirX = originX === \"left\" ? 1 : -1;\n      const dirY = originY === \"top\" ? 1 : -1;\n      centerOffsetX = (dirX * (requestedWidth - targetWidth)) / 2;\n      centerOffsetY = (dirY * (requestedHeight - targetHeight)) / 2;\n    }\n\n    img.set({\n      left: left + centerOffsetX,\n      top: top + centerOffsetY,\n    });\n\n    if (resizeMode === \"contain-blur\") {\n      const mutableImg = img.cloneAsImage({});\n      const blurredImg = await blurImage({\n        mutableImg,\n        width: requestedWidth,\n        height: requestedHeight,\n      });\n      blurredImg.set({\n        left,\n        top,\n        originX,\n        originY,\n      });\n      canvas.add(blurredImg);\n    }\n\n    if (fabricImagePostProcessing) {\n      fabricImagePostProcessing({ image: img, progress, fabric, canvas, time });\n    }\n\n    canvas.add(img);\n  }\n\n  const close = () => {\n    if (verbose) console.log(\"Close\", path);\n    if (!ps.exitCode) controller.abort();\n  };\n\n  return {\n    readNextFrame,\n    close,\n  };\n});\n","import assert from \"assert\";\n\nimport { join } from \"path\";\nimport { fileURLToPath } from \"url\";\nimport canvas from \"./canvas.js\";\nimport fabric from \"./fabric.js\";\nimport fillColor from \"./fill-color.js\";\nimport gl from \"./gl.js\";\nimport imageOverlay from \"./image-overlay.js\";\nimport image from \"./image.js\";\nimport linearGradient from \"./linear-gradient.js\";\nimport newsTitle from \"./news-title.js\";\nimport radialGradient from \"./radial-gradient.js\";\nimport slideInText from \"./slide-in-text.js\";\nimport subtitle from \"./subtitle.js\";\nimport title from \"./title.js\";\nimport video from \"./video.js\";\n\nimport type { CreateFrameSourceOptions, FrameSourceFactory } from \"../api/index.js\";\nimport type {\n  BaseLayer,\n  FillColorLayer,\n  GlLayer,\n  Layer,\n  LinearGradientLayer,\n  TitleLayer,\n} from \"../types.js\";\n\nconst dirname = fileURLToPath(new URL(\"..\", import.meta.url));\n\nconst sources = [\n  canvas,\n  fabric,\n  fillColor,\n  gl,\n  imageOverlay,\n  image,\n  linearGradient,\n  newsTitle,\n  radialGradient,\n  slideInText,\n  subtitle,\n  title,\n  video,\n];\n\nexport async function createLayerSource<T extends BaseLayer>(options: CreateFrameSourceOptions<T>) {\n  const layer = options.params;\n  const source = sources.find(({ type }) => type == layer.type) as\n    | FrameSourceFactory<T>\n    | undefined;\n  assert(source, `Invalid type ${layer.type}`);\n  return await source.setup(options);\n}\n\nexport function expandLayerAliases(params: Layer): Layer[] {\n  if (params.type === \"editly-banner\") {\n    return [\n      { type: \"linear-gradient\" } as LinearGradientLayer,\n      { ...params, type: \"title\", text: \"Made with\\nEDITLY\\nmifi.no\" } as TitleLayer,\n    ];\n  }\n\n  if (params.type === \"title-background\") {\n    const backgroundTypes: (\"radial-gradient\" | \"linear-gradient\" | \"fill-color\")[] = [\n      \"radial-gradient\",\n      \"linear-gradient\",\n      \"fill-color\",\n    ];\n\n    const {\n      background = { type: backgroundTypes[Math.floor(Math.random() * backgroundTypes.length)] },\n      ...title\n    } = params;\n\n    return [background, { ...title, type: \"title\" }];\n  }\n\n  // TODO if random-background radial-gradient linear etc\n  if (params.type === \"pause\") {\n    return [{ ...params, type: \"fill-color\" } as FillColorLayer];\n  }\n\n  if (params.type === \"rainbow-colors\") {\n    return [{ type: \"gl\", fragmentPath: join(dirname, \"shaders/rainbow-colors.frag\") } as GlLayer];\n  }\n  return [params];\n}\n\nexport default sources;\n","import assert from \"assert\";\nimport { merge } from \"lodash-es\";\nimport { nanoid } from \"nanoid\";\nimport { dirname, join } from \"path\";\nimport { expandLayerAliases } from \"./sources/index.js\";\nimport type { AudioNormalizationOptions, AudioTrack, Clip, DefaultOptions } from \"./types.js\";\n\nexport type DebugOptions = {\n  verbose?: boolean;\n  logTimes?: boolean;\n};\n\nexport type FfmpegConfig = {\n  ffmpegPath?: string;\n  ffprobePath?: string;\n  enableFfmpegLog?: boolean;\n};\n\nexport type ConfigurationOptions = {\n  /**\n   * Output path (`.mp4` or `.mkv`, can also be a `.gif`).\n   */\n  outPath: string;\n\n  /**\n   * List of clip objects that will be played in sequence.\n   * Each clip can have one or more layers.\n   *\n   * @default []\n   */\n  clips: Clip[];\n\n  /**\n   * Width which all media will be converted to.\n   *\n   * @default 640\n   */\n  width?: number;\n\n  /**\n   * Height which all media will be converted to.\n   * Decides height based on `width` and aspect ratio of the first video by default.\n   */\n  height?: number;\n\n  /**\n   * FPS which all videos will be converted to.\n   * Defaults to first video's FPS or `25`.\n   */\n  fps?: number;\n\n  /**\n   * Specify custom output codec/format arguments for ffmpeg.\n   * Automatically adds codec options (normally `h264`) by default.\n   *\n   * @see [Example]{@link https://github.com/mifi/editly/blob/master/examples/customOutputArgs.json5}\n   */\n  customOutputArgs?: string[];\n\n  /**\n   * Allow remote URLs as paths.\n   *\n   * @default false\n   */\n  allowRemoteRequests?: boolean;\n\n  /**\n   * Fast mode (low resolution and FPS, useful for getting a quick preview ⏩).\n   *\n   * @default false\n   */\n  fast?: boolean;\n\n  /**\n   * An object describing default options for clips and layers.\n   */\n  defaults?: DefaultOptions;\n\n  /**\n   * List of arbitrary audio tracks.\n   *\n   * @default []\n   * @see [Audio tracks]{@link https://github.com/mifi/editly#arbitrary-audio-tracks}\n   */\n  audioTracks?: AudioTrack[];\n\n  /**\n   * Set an audio track for the whole video..\n   *\n   * @see [Audio tracks]{@link https://github.com/mifi/editly#arbitrary-audio-tracks}\n   */\n  audioFilePath?: string;\n\n  /**\n   * Background Volume\n   *\n   * @see [Audio tracks]{@link https://github.com/mifi/editly#arbitrary-audio-tracks}\n   */\n  backgroundAudioVolume?: string | number;\n\n  /**\n   * Loop the audio track if it is shorter than video?\n   *\n   * @default false\n   */\n  loopAudio?: boolean;\n\n  /**\n   * Keep source audio from `clips`?\n   *\n   * @default false\n   */\n  keepSourceAudio?: boolean;\n\n  /**\n   * Volume of audio from `clips` relative to `audioTracks`.\n   *\n   * @default 1\n   * @see [Audio tracks]{@link https://github.com/mifi/editly#arbitrary-audio-tracks}\n   */\n  clipsAudioVolume?: number | string;\n\n  /**\n   * Adjust output [volume]{@link http://ffmpeg.org/ffmpeg-filters.html#volume} (final stage).\n   *\n   * @default 1\n   * @see [Example]{@link https://github.com/mifi/editly/blob/master/examples/audio-volume.json5}\n   * @example\n   * 0.5\n   * @example\n   * '10db'\n   */\n  outputVolume?: number | string;\n\n  /**\n   * Audio normalization.\n   */\n  audioNorm?: AudioNormalizationOptions;\n\n  /**\n   * WARNING: Undocumented feature!\n   */\n  keepTmp?: boolean;\n} & DebugOptions &\n  FfmpegConfig;\n\nexport type LayerSourceConfig = Pick<\n  Configuration,\n  \"verbose\" | \"allowRemoteRequests\" | \"logTimes\" | \"tmpDir\"\n>;\n\nconst globalDefaults = {\n  duration: 4,\n  transition: {\n    duration: 0.5,\n    name: \"random\",\n    audioOutCurve: \"tri\",\n    audioInCurve: \"tri\",\n  },\n};\n\nexport class Configuration {\n  clips: Clip[];\n  outPath: string;\n  tmpDir: string;\n  allowRemoteRequests: boolean;\n  customOutputArgs?: string[];\n  defaults: DefaultOptions;\n\n  // Video\n  width?: number;\n  height?: number;\n  fps?: number;\n\n  // Audio\n  audioFilePath?: string;\n  backgroundAudioVolume?: string | number;\n  loopAudio?: boolean;\n  keepSourceAudio?: boolean;\n  audioNorm?: AudioNormalizationOptions;\n  outputVolume?: number | string;\n  clipsAudioVolume: string | number;\n  audioTracks: AudioTrack[];\n\n  // Debug\n  enableFfmpegLog: boolean;\n  verbose: boolean;\n  logTimes: boolean;\n  keepTmp: boolean;\n  fast: boolean;\n  ffmpegPath: string;\n  ffprobePath: string;\n\n  constructor(input: ConfigurationOptions) {\n    assert(input.outPath, \"Please provide an output path\");\n    assert(Array.isArray(input.clips) && input.clips.length > 0, \"Please provide at least 1 clip\");\n    assert(\n      !input.customOutputArgs || Array.isArray(input.customOutputArgs),\n      \"customOutputArgs must be an array of arguments\",\n    );\n\n    this.outPath = input.outPath;\n    this.width = input.width;\n    this.height = input.height;\n    this.fps = input.fps;\n    this.audioFilePath = input.audioFilePath;\n    this.backgroundAudioVolume = input.backgroundAudioVolume;\n    this.loopAudio = input.loopAudio;\n    this.clipsAudioVolume = input.clipsAudioVolume ?? 1;\n    this.audioTracks = input.audioTracks ?? [];\n    this.keepSourceAudio = input.keepSourceAudio;\n    this.allowRemoteRequests = input.allowRemoteRequests ?? false;\n    this.audioNorm = input.audioNorm;\n    this.outputVolume = input.outputVolume;\n    this.customOutputArgs = input.customOutputArgs;\n    this.defaults = merge({}, globalDefaults, input.defaults);\n\n    this.clips = input.clips.map((clip) => {\n      let { layers } = clip;\n\n      if (layers && !Array.isArray(layers)) layers = [layers]; // Allow single layer for convenience\n      assert(\n        Array.isArray(layers) && layers.length > 0,\n        \"clip.layers must be an array with at least one layer.\",\n      );\n\n      layers = layers\n        .map(expandLayerAliases)\n        .flat()\n        .map((layer) => {\n          assert(layer.type, 'All \"layers\" must have a type');\n          return merge(\n            {},\n            this.defaults.layer ?? {},\n            this.defaults.layerType?.[layer.type] ?? {},\n            layer,\n          );\n        });\n\n      const { transition } = merge({}, this.defaults, clip);\n      assert(transition == null || typeof transition === \"object\", \"Transition must be an object\");\n\n      return { transition, layers, duration: clip.duration };\n    });\n\n    // Testing options:\n    this.verbose = input.verbose ?? false;\n    this.enableFfmpegLog = input.enableFfmpegLog ?? this.verbose;\n    this.logTimes = input.logTimes ?? false;\n    this.keepTmp = input.keepTmp ?? false;\n    this.fast = input.fast ?? false;\n\n    this.ffmpegPath = input.ffmpegPath ?? \"ffmpeg\";\n    this.ffprobePath = input.ffprobePath ?? \"ffprobe\";\n\n    this.tmpDir = join(this.outDir, `editly-tmp-${nanoid()}`);\n  }\n\n  get outDir() {\n    return dirname(this.outPath);\n  }\n\n  get isGif() {\n    return this.outPath.toLowerCase().endsWith(\".gif\");\n  }\n}\n","import pMap from \"p-map\";\nimport type { DebugOptions } from \"./configuration.js\";\nimport type { ProcessedClip } from \"./parseConfig.js\";\nimport { createFabricCanvas, renderFabricCanvas, rgbaToFabricImage } from \"./sources/fabric.js\";\nimport { createLayerSource } from \"./sources/index.js\";\n\ntype FrameSourceOptions = DebugOptions & {\n  clip: ProcessedClip;\n  clipIndex: number;\n  width: number;\n  height: number;\n  channels: number;\n  framerateStr: string;\n};\n\nexport async function createFrameSource({\n  clip,\n  clipIndex,\n  width,\n  height,\n  channels,\n  verbose,\n  logTimes,\n  framerateStr,\n}: FrameSourceOptions) {\n  const { layers, duration } = clip;\n\n  const visualLayers = layers.filter((layer) => layer.type !== \"audio\");\n\n  const layerFrameSources = await pMap(\n    visualLayers,\n    async (layer, layerIndex) => {\n      if (verbose)\n        console.log(\"createFrameSource\", layer.type, \"clip\", clipIndex, \"layer\", layerIndex);\n      const options = {\n        width,\n        height,\n        duration,\n        channels,\n        verbose,\n        logTimes,\n        framerateStr,\n        params: layer,\n      };\n      return createLayerSource(options);\n    },\n    { concurrency: 1 },\n  );\n\n  async function readNextFrame({ time }: { time: number }) {\n    const canvas = createFabricCanvas({ width, height });\n\n    for (const frameSource of layerFrameSources) {\n      if (logTimes) console.time(\"frameSource.readNextFrame\");\n      const rgba = await frameSource.readNextFrame(time, canvas);\n      if (logTimes) console.timeEnd(\"frameSource.readNextFrame\");\n\n      // Frame sources can either render to the provided canvas and return nothing\n      // OR return an raw RGBA blob which will be drawn onto the canvas\n      if (rgba) {\n        // Optimization: Don't need to draw to canvas if there's only one layer\n        if (layerFrameSources.length === 1) return rgba;\n\n        if (logTimes) console.time(\"rgbaToFabricImage\");\n        const img = await rgbaToFabricImage({ width, height, rgba });\n        if (logTimes) console.timeEnd(\"rgbaToFabricImage\");\n        canvas.add(img);\n      } else {\n        // Assume this frame source has drawn its content to the canvas\n      }\n    }\n    // if (verbose) console.time('Merge frames');\n\n    if (logTimes) console.time(\"renderFabricCanvas\");\n    const rgba = await renderFabricCanvas(canvas);\n    if (logTimes) console.timeEnd(\"renderFabricCanvas\");\n    return rgba;\n  }\n\n  async function close() {\n    await pMap(layerFrameSources, (frameSource) => frameSource.close?.());\n  }\n\n  return {\n    readNextFrame,\n    close,\n  };\n}\n\nexport default {\n  createFrameSource,\n};\n","import assert from \"assert\";\nimport GL from \"gl\";\nimport createBuffer from \"gl-buffer\";\nimport createTexture from \"gl-texture2d\";\nimport glTransition from \"gl-transition\";\nimport glTransitions, { type GlTransition } from \"gl-transitions\";\nimport ndarray from \"ndarray\";\nimport type { EasingFunction } from \"./easings.js\";\nimport * as easings from \"./easings.js\";\n\nconst { default: createTransition } = glTransition;\n\nconst TransitionAliases: Record<string, Partial<TransitionOptions>> = {\n  \"directional-left\": { name: \"directional\", easing: \"easeOutExpo\", params: { direction: [1, 0] } },\n  \"directional-right\": {\n    name: \"directional\",\n    easing: \"easeOutExpo\",\n    params: { direction: [-1, 0] },\n  },\n  \"directional-down\": { name: \"directional\", easing: \"easeOutExpo\", params: { direction: [0, 1] } },\n  \"directional-up\": { name: \"directional\", easing: \"easeOutExpo\", params: { direction: [0, -1] } },\n};\n\nconst AllTransitions = [...glTransitions.map((t) => t.name), ...Object.keys(TransitionAliases)];\n\n/**\n * @see [Transition types]{@link https://github.com/mifi/editly#transition-types}\n */\nexport type TransitionType =\n  | \"directional-left\"\n  | \"directional-right\"\n  | \"directional-up\"\n  | \"directional-down\"\n  | \"random\"\n  | \"dummy\"\n  | string;\n\n/**\n * WARNING: Undocumented feature!\n */\nexport type GLTextureLike = {\n  bind: (unit: number) => number;\n  shape: [number, number];\n};\n\n/**\n * WARNING: Undocumented feature!\n */\nexport interface TransitionParams {\n  /**\n   * WARNING: Undocumented feature!\n   */\n  [key: string]: number | boolean | GLTextureLike | number[];\n}\n\nexport type RunTransitionOptions = {\n  fromFrame: Buffer;\n  toFrame: Buffer;\n  progress: number;\n  transitionName?: string;\n  transitionParams?: TransitionParams;\n};\n\n/**\n * @see [Curve types]{@link https://trac.ffmpeg.org/wiki/AfadeCurves}\n */\nexport type CurveType =\n  | \"tri\"\n  | \"qsin\"\n  | \"hsin\"\n  | \"esin\"\n  | \"log\"\n  | \"ipar\"\n  | \"qua\"\n  | \"cub\"\n  | \"squ\"\n  | \"cbr\"\n  | \"par\"\n  | \"exp\"\n  | \"iqsin\"\n  | \"ihsin\"\n  | \"dese\"\n  | \"desi\"\n  | \"losi\"\n  | \"nofade\"\n  | string;\n\nexport type Easing = keyof typeof easings;\n\nexport interface TransitionOptions {\n  /**\n   * Transition duration.\n   *\n   * @default 0.5\n   */\n  duration?: number;\n\n  /**\n   * Transition type.\n   *\n   * @default 'random'\n   * @see [Transition types]{@link https://github.com/mifi/editly#transition-types}\n   */\n  name?: TransitionType;\n\n  /**\n   * [Fade out curve]{@link https://trac.ffmpeg.org/wiki/AfadeCurves} in audio cross fades.\n   *\n   * @default 'tri'\n   */\n  audioOutCurve?: CurveType;\n\n  /**\n   * [Fade in curve]{@link https://trac.ffmpeg.org/wiki/AfadeCurves} in audio cross fades.\n   *\n   * @default 'tri'\n   */\n  audioInCurve?: CurveType;\n\n  /**\n   * WARNING: Undocumented feature!\n   */\n  easing?: Easing | null;\n\n  /**\n   * WARNING: Undocumented feature!\n   */\n  params?: TransitionParams;\n}\n\nfunction getRandomTransition() {\n  return AllTransitions[Math.floor(Math.random() * AllTransitions.length)];\n}\n\nexport class Transition {\n  name?: string;\n  duration: number;\n  params?: TransitionParams;\n  easingFunction: EasingFunction;\n  source?: GlTransition;\n\n  constructor(options?: TransitionOptions | null, isLastClip: boolean = false) {\n    if (!options || isLastClip) options = { duration: 0 };\n\n    assert(typeof options === \"object\", \"Transition must be an object\");\n    assert(\n      options.duration === 0 || options.name,\n      \"Please specify transition name or set duration to 0\",\n    );\n\n    if (options.name === \"random\") options.name = getRandomTransition();\n    const aliasedTransition = options.name && TransitionAliases[options.name];\n    if (aliasedTransition) Object.assign(options, aliasedTransition);\n\n    this.duration = options.duration ?? 0;\n    this.name = options.name;\n    this.params = options.params;\n    this.easingFunction =\n      options.easing && easings[options.easing] ? easings[options.easing] : easings.linear;\n\n    // A dummy transition can be used to have an audio transition without a video transition\n    // (Note: You will lose a portion from both clips due to overlap)\n    if (this.name && this.name !== \"dummy\") {\n      this.source = glTransitions.find(\n        ({ name }) => name.toLowerCase() === this.name?.toLowerCase(),\n      );\n      assert(this.source, `Transition not found: ${this.name}`);\n    }\n  }\n\n  create({ width, height, channels }: { width: number; height: number; channels: number }) {\n    const gl = GL(width, height);\n    const resizeMode = \"stretch\";\n\n    if (!gl) {\n      throw new Error(\n        \"gl returned null, this probably means that some dependencies are not installed. See README.\",\n      );\n    }\n\n    function convertFrame(buf: Buffer) {\n      // @see https://github.com/stackgl/gl-texture2d/issues/16\n      return ndarray(buf, [width, height, channels], [channels, width * channels, 1]);\n    }\n\n    return ({ fromFrame, toFrame, progress }: RunTransitionOptions) => {\n      if (!this.source) {\n        // No transition found, just switch frames half way through the transition.\n        return this.easingFunction(progress) > 0.5 ? toFrame : fromFrame;\n      }\n\n      const buffer = createBuffer(gl, [-1, -1, -1, 4, 4, -1], gl.ARRAY_BUFFER, gl.STATIC_DRAW);\n      let transition;\n\n      try {\n        transition = createTransition(gl, this.source, { resizeMode });\n\n        gl.clear(gl.COLOR_BUFFER_BIT);\n\n        // console.time('runTransitionOnFrame internal');\n        const fromFrameNdArray = convertFrame(fromFrame);\n        const textureFrom = createTexture(gl, fromFrameNdArray);\n        textureFrom.minFilter = gl.LINEAR;\n        textureFrom.magFilter = gl.LINEAR;\n\n        // console.timeLog('runTransitionOnFrame internal');\n        const toFrameNdArray = convertFrame(toFrame);\n        const textureTo = createTexture(gl, toFrameNdArray);\n        textureTo.minFilter = gl.LINEAR;\n        textureTo.magFilter = gl.LINEAR;\n\n        buffer.bind();\n        transition.draw(\n          this.easingFunction(progress),\n          textureFrom,\n          textureTo,\n          gl.drawingBufferWidth,\n          gl.drawingBufferHeight,\n          this.params,\n        );\n\n        textureFrom.dispose();\n        textureTo.dispose();\n\n        // console.timeLog('runTransitionOnFrame internal');\n\n        const outArray = Buffer.allocUnsafe(width * height * 4);\n        gl.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, outArray);\n\n        // console.timeEnd('runTransitionOnFrame internal');\n\n        return outArray;\n\n        // require('fs').writeFileSync(`${new Date().getTime()}.raw`, outArray);\n        // Testing: ffmpeg -f rawvideo -vcodec rawvideo -pix_fmt rgba -s 2166x1650 -i 1586619627191.raw -vf format=yuv420p -vcodec libx264 -y out.mp4\n      } finally {\n        buffer.dispose();\n        if (transition) transition.dispose();\n      }\n    };\n  }\n}\n","import assert from \"assert\";\nimport { registerFont } from \"canvas\";\nimport flatMap from \"lodash-es/flatMap.js\";\nimport pMap from \"p-map\";\nimport { basename } from \"path\";\nimport { Configuration } from \"./configuration.js\";\nimport { readDuration, readVideoFileInfo } from \"./ffmpeg.js\";\nimport { Transition } from \"./transition.js\";\nimport type {\n  AudioTrack,\n  CanvasLayer,\n  FabricLayer,\n  ImageLayer,\n  ImageOverlayLayer,\n  Layer,\n  NewsTitleLayer,\n  SlideInTextLayer,\n  SubtitleLayer,\n  TitleLayer,\n  VideoLayer,\n} from \"./types.js\";\nimport { assertFileValid } from \"./util.js\";\n\nexport type ProcessedClip = {\n  layers: Layer[];\n  duration: number;\n  transition: Transition;\n};\n\n// Cache\nconst loadedFonts: string[] = [];\n\nasync function validateArbitraryAudio(\n  audio: AudioTrack[] | undefined,\n  allowRemoteRequests?: boolean,\n) {\n  assert(audio === undefined || Array.isArray(audio));\n\n  if (audio) {\n    for (const { path, cutFrom, cutTo, start } of audio) {\n      await assertFileValid(path, allowRemoteRequests);\n\n      if (cutFrom != null && cutTo != null) assert(cutTo > cutFrom);\n      if (cutFrom != null) assert(cutFrom >= 0);\n      if (cutTo != null) assert(cutTo >= 0);\n      assert(start == null || start >= 0, `Invalid \"start\" ${start}`);\n    }\n  }\n}\n\ntype ParseConfigOptions = {\n  backgroundAudioPath?: string;\n  arbitraryAudio: AudioTrack[];\n} & Pick<\n  Configuration,\n  \"clips\" | \"backgroundAudioVolume\" | \"loopAudio\" | \"allowRemoteRequests\" | \"defaults\"\n>;\n\nexport default async function parseConfig({\n  clips,\n  arbitraryAudio: arbitraryAudioIn,\n  backgroundAudioPath,\n  backgroundAudioVolume,\n  loopAudio,\n  allowRemoteRequests,\n  defaults,\n}: ParseConfigOptions) {\n  async function handleLayer(layer: Layer): Promise<Layer | Layer[]> {\n    // https://github.com/mifi/editly/issues/39\n    if (layer.type === \"image\" || layer.type === \"image-overlay\") {\n      await assertFileValid((layer as ImageOverlayLayer | ImageLayer).path, allowRemoteRequests);\n    } else if (layer.type === \"gl\") {\n      await assertFileValid(layer.fragmentPath, allowRemoteRequests);\n    }\n\n    if ([\"fabric\", \"canvas\"].includes(layer.type)) {\n      assert(\n        typeof (layer as FabricLayer | CanvasLayer).func === \"function\",\n        '\"func\" must be a function',\n      );\n    }\n\n    if (\n      [\n        \"image\",\n        \"image-overlay\",\n        \"fabric\",\n        \"canvas\",\n        \"gl\",\n        \"radial-gradient\",\n        \"linear-gradient\",\n        \"fill-color\",\n      ].includes(layer.type)\n    ) {\n      return layer;\n    }\n\n    if ([\"title\", \"subtitle\", \"news-title\", \"slide-in-text\"].includes(layer.type)) {\n      const { fontPath, ...rest } = layer as\n        | TitleLayer\n        | SubtitleLayer\n        | NewsTitleLayer\n        | SlideInTextLayer;\n      assert(rest.text, \"Please specify a text\");\n\n      let { fontFamily } = rest;\n      if (fontPath) {\n        fontFamily = Buffer.from(basename(fontPath)).toString(\"base64\");\n        if (!loadedFonts.includes(fontFamily)) {\n          registerFont(fontPath, { family: fontFamily, weight: \"regular\", style: \"normal\" });\n          loadedFonts.push(fontFamily);\n        }\n      }\n      return { ...rest, fontFamily };\n    }\n\n    throw new Error(`Invalid layer type ${layer.type}`);\n  }\n\n  const detachedAudioByClip: Record<number, AudioTrack[]> = {};\n\n  let clipsOut: ProcessedClip[] = await pMap(\n    clips,\n    async (clip, clipIndex) => {\n      const { layers } = clip;\n      const transition = new Transition(clip.transition, clipIndex === clips.length - 1);\n\n      let layersOut = flatMap(\n        await pMap(\n          layers,\n          async <T extends Layer>(layer: T) => {\n            if (layer.type === \"video\") {\n              const {\n                duration: fileDuration,\n                width: widthIn,\n                height: heightIn,\n                framerateStr,\n                rotation,\n              } = await readVideoFileInfo(layer.path);\n              let { cutFrom, cutTo } = layer;\n              if (!cutFrom) cutFrom = 0;\n              cutFrom = Math.max(cutFrom, 0);\n              cutFrom = Math.min(cutFrom, fileDuration);\n\n              if (!cutTo) cutTo = fileDuration;\n              cutTo = Math.max(cutTo, cutFrom);\n              cutTo = Math.min(cutTo, fileDuration);\n              assert(cutFrom < cutTo, \"cutFrom must be lower than cutTo\");\n\n              const layerDuration = cutTo - cutFrom;\n\n              const isRotated = rotation && [-90, 90, 270, -270].includes(rotation);\n              const inputWidth = isRotated ? heightIn : widthIn;\n              const inputHeight = isRotated ? widthIn : heightIn;\n\n              return {\n                ...layer,\n                cutFrom,\n                cutTo,\n                layerDuration,\n                framerateStr,\n                inputWidth,\n                inputHeight,\n              } as T;\n            }\n\n            // Audio is handled later\n            if ([\"audio\", \"detached-audio\"].includes(layer.type)) return layer;\n\n            return handleLayer(layer);\n          },\n          { concurrency: 1 },\n        ),\n      );\n\n      let clipDuration = clip.duration;\n\n      if (!clipDuration) {\n        const video = layersOut.find((layer): layer is VideoLayer => layer.type === \"video\");\n        clipDuration = video?.layerDuration ?? defaults.duration;\n      }\n\n      assert(clipDuration, `Duration parameter is required for videoless clip ${clipIndex}`);\n\n      // We need to map again, because for audio, we need to know the correct clipDuration\n      layersOut = (\n        await pMap(layersOut, async <T extends Layer>(layerIn: T) => {\n          if (!layerIn.start) layerIn.start = 0;\n\n          // This feature allows the user to show another layer overlayed (or replacing) parts of the lower layers (start - stop)\n          const layerDuration = (layerIn.stop || clipDuration) - layerIn.start;\n          assert(\n            layerDuration > 0 && layerDuration <= clipDuration,\n            `Invalid start ${layerIn.start} or stop ${layerIn.stop} (${clipDuration})`,\n          );\n          // TODO Also need to handle video layers (speedFactor etc)\n          // TODO handle audio in case of start/stop\n\n          const layer: T = { ...layerIn, layerDuration };\n\n          if (layer.type === \"audio\") {\n            const fileDuration = await readDuration(layer.path);\n            let { cutFrom, cutTo } = layer;\n\n            // console.log({ cutFrom, cutTo, fileDuration, clipDuration });\n\n            if (!cutFrom) cutFrom = 0;\n            cutFrom = Math.max(cutFrom, 0);\n            cutFrom = Math.min(cutFrom, fileDuration);\n\n            if (!cutTo) cutTo = cutFrom + clipDuration;\n            cutTo = Math.max(cutTo, cutFrom);\n            cutTo = Math.min(cutTo, fileDuration);\n            assert(cutFrom < cutTo, \"cutFrom must be lower than cutTo\");\n\n            const layerDuration = cutTo - cutFrom;\n\n            const speedFactor = clipDuration / layerDuration;\n\n            return { ...layer, cutFrom, cutTo, speedFactor };\n          }\n\n          if (layer.type === \"video\") {\n            let speedFactor;\n\n            // If user explicitly specified duration for clip, it means that should be the output duration of the video\n            if (clipDuration) {\n              // Later we will speed up or slow down video using this factor\n              speedFactor = clipDuration / layerDuration;\n            } else {\n              speedFactor = 1;\n            }\n\n            return { ...layer, speedFactor };\n          }\n\n          // These audio tracks are detached from the clips (can run over multiple clips)\n          // This is useful so we can have audio start relative to their parent clip's start time\n          if (layer.type === \"detached-audio\") {\n            if (!detachedAudioByClip[clipIndex]) detachedAudioByClip[clipIndex] = [];\n            detachedAudioByClip[clipIndex].push(layer);\n            return undefined; // Will be filtered out\n          }\n\n          return layer;\n        })\n      ).filter((l) => l !== undefined);\n\n      // Filter out deleted layers\n      layersOut = layersOut.filter((l) => l);\n\n      return {\n        transition,\n        duration: clipDuration,\n        layers: layersOut,\n      };\n    },\n    { concurrency: 1 },\n  );\n\n  let totalClipDuration = 0;\n  const clipDetachedAudio: AudioTrack[] = [];\n\n  // Need to map again because now we know all clip durations, and we can adjust transitions so they are safe\n  clipsOut = await pMap(clipsOut, async (clip, i) => {\n    const nextClip = clipsOut[i + 1];\n\n    // We clamp all transitions to half the length of every clip. If not, we risk that clips that are too short,\n    // will be eaten by transitions and could cause de-sync issues with audio/video\n    // NOTE: similar logic is duplicated in index.js\n    let safeTransitionDuration = 0;\n    if (nextClip) {\n      // Each clip can have two transitions, make sure we leave enough room:\n      safeTransitionDuration = Math.min(\n        clip.duration / 2,\n        nextClip.duration / 2,\n        clip.transition!.duration!,\n      );\n    }\n\n    // We now know all clip durations so we can calculate the offset for detached audio tracks\n    for (const { start, ...rest } of detachedAudioByClip[i] || []) {\n      clipDetachedAudio.push({ ...rest, start: totalClipDuration + (start || 0) });\n    }\n\n    totalClipDuration += clip.duration - safeTransitionDuration;\n    clip.transition.duration = safeTransitionDuration;\n\n    return clip;\n  });\n\n  // Audio can either come from `audioFilePath`, `audio` or from \"detached\" audio layers from clips\n  const arbitraryAudio = [\n    // Background audio is treated just like arbitrary audio\n    ...(backgroundAudioPath\n      ? [\n          {\n            path: backgroundAudioPath,\n            mixVolume: backgroundAudioVolume != null ? backgroundAudioVolume : 1,\n            loop: loopAudio ? -1 : 0,\n          },\n        ]\n      : []),\n    ...arbitraryAudioIn,\n    ...clipDetachedAudio,\n  ];\n\n  await validateArbitraryAudio(arbitraryAudio, allowRemoteRequests);\n\n  return {\n    clips: clipsOut,\n    arbitraryAudio,\n  };\n}\n","import assert from \"assert\";\nimport { Options, ResultPromise } from \"execa\";\nimport fsExtra from \"fs-extra\";\nimport JSON5 from \"json5\";\n\nimport Audio from \"./audio.js\";\nimport { Configuration, type ConfigurationOptions } from \"./configuration.js\";\nimport { configureFf, ffmpeg, parseFps } from \"./ffmpeg.js\";\nimport { createFrameSource } from \"./frameSource.js\";\nimport parseConfig, { ProcessedClip } from \"./parseConfig.js\";\nimport { createFabricCanvas, rgbaToFabricImage } from \"./sources/fabric.js\";\nimport type { RenderSingleFrameConfig } from \"./types.js\";\nimport { assertFileValid, multipleOf2 } from \"./util.js\";\n\nconst channels = 4;\n\nexport type * from \"./transition.js\";\nexport type * from \"./types.js\";\n\n/**\n * Edit and render videos.\n *\n * @param config - ConfigurationOptions.\n */\nasync function Editly(input: ConfigurationOptions): Promise<void> {\n  const config = new Configuration(input);\n  const {\n    // Testing options:\n    verbose = false,\n    logTimes = false,\n    keepTmp = false,\n    fast = false,\n\n    outPath,\n    clips: clipsIn,\n    clipsAudioVolume,\n    audioTracks: arbitraryAudioIn,\n    width: requestedWidth,\n    height: requestedHeight,\n    fps: requestedFps,\n    audioFilePath: backgroundAudioPath,\n    backgroundAudioVolume,\n    loopAudio,\n    keepSourceAudio,\n    allowRemoteRequests,\n    audioNorm,\n    outputVolume,\n    customOutputArgs,\n    isGif,\n    tmpDir,\n    defaults,\n  } = config;\n\n  await configureFf(config);\n\n  if (backgroundAudioPath) await assertFileValid(backgroundAudioPath, allowRemoteRequests);\n\n  if (verbose) console.log(JSON5.stringify(config, null, 2));\n\n  const { clips, arbitraryAudio } = await parseConfig({\n    clips: clipsIn,\n    arbitraryAudio: arbitraryAudioIn,\n    backgroundAudioPath,\n    backgroundAudioVolume,\n    loopAudio,\n    allowRemoteRequests,\n    defaults,\n  });\n  if (verbose) console.log(\"Calculated\", JSON5.stringify({ clips, arbitraryAudio }, null, 2));\n\n  if (verbose) console.log({ tmpDir });\n  await fsExtra.mkdirp(tmpDir);\n\n  const { editAudio } = Audio({ verbose, tmpDir });\n\n  const audioFilePath = !isGif\n    ? await editAudio({\n        keepSourceAudio,\n        arbitraryAudio,\n        clipsAudioVolume,\n        clips,\n        audioNorm,\n        outputVolume,\n      })\n    : undefined;\n\n  // Try to detect parameters from first video\n  let firstVideoWidth;\n  let firstVideoHeight;\n  let firstVideoFramerateStr;\n\n  clips.find(\n    (clip) =>\n      clip &&\n      clip.layers.find((layer) => {\n        if (layer.type === \"video\") {\n          firstVideoWidth = layer.inputWidth;\n          firstVideoHeight = layer.inputHeight;\n          firstVideoFramerateStr = layer.framerateStr;\n\n          return true;\n        }\n        return false;\n      }),\n  );\n\n  let width: number;\n  let height: number;\n\n  let desiredWidth;\n\n  if (requestedWidth) desiredWidth = requestedWidth;\n  else if (isGif) desiredWidth = 320;\n\n  const roundDimension = (val: number) => (isGif ? Math.round(val) : multipleOf2(val));\n\n  if (firstVideoWidth && firstVideoHeight) {\n    if (desiredWidth) {\n      const calculatedHeight = (firstVideoHeight / firstVideoWidth) * desiredWidth;\n      height = roundDimension(calculatedHeight);\n      width = desiredWidth;\n    } else {\n      width = firstVideoWidth;\n      height = firstVideoHeight;\n    }\n  } else if (desiredWidth) {\n    width = desiredWidth;\n    height = desiredWidth;\n    // console.log(`Cannot detect width/height from video, set defaults ${width}x${height}`);\n  } else {\n    // No video\n    width = 640;\n    height = 640;\n  }\n\n  // User override?\n  if (requestedWidth && requestedHeight) {\n    width = requestedWidth;\n    height = requestedHeight;\n  }\n\n  if (fast) {\n    const numPixelsEachDirection = 250;\n    const aspectRatio = width / height;\n    width = roundDimension(numPixelsEachDirection * Math.sqrt(aspectRatio));\n    height = roundDimension(numPixelsEachDirection * Math.sqrt(1 / aspectRatio));\n  }\n\n  assert(width, \"Width not specified or detected\");\n  assert(height, \"Height not specified or detected\");\n\n  if (!isGif) {\n    // x264 requires multiple of 2, eg minimum 2\n    width = Math.max(2, width);\n    height = Math.max(2, height);\n  }\n\n  let fps: number;\n  let framerateStr: string;\n\n  if (fast) {\n    fps = 15;\n    framerateStr = String(fps);\n  } else if (requestedFps && typeof requestedFps === \"number\") {\n    fps = requestedFps;\n    framerateStr = String(requestedFps);\n  } else if (isGif) {\n    fps = 10;\n    framerateStr = String(fps);\n  } else if (firstVideoFramerateStr) {\n    fps = parseFps(firstVideoFramerateStr) ?? 25;\n    framerateStr = firstVideoFramerateStr;\n  } else {\n    fps = 25;\n    framerateStr = String(fps);\n  }\n\n  assert(fps, \"FPS not specified or detected\");\n\n  console.log(`${width}x${height} ${fps}fps`);\n\n  const estimatedTotalFrames =\n    fps *\n    clips.reduce((acc, c, i) => {\n      let newAcc = acc + c.duration;\n      if (i !== clips.length - 1) newAcc -= c.transition.duration;\n      return newAcc;\n    }, 0);\n\n  function getOutputArgs() {\n    if (customOutputArgs) {\n      assert(Array.isArray(customOutputArgs), \"customOutputArgs must be an array of arguments\");\n      return customOutputArgs;\n    }\n\n    // https://superuser.com/questions/556029/how-do-i-convert-a-video-to-gif-using-ffmpeg-with-reasonable-quality\n    const videoOutputArgs = isGif\n      ? [\n          \"-vf\",\n          `format=rgb24,fps=${fps},scale=${width}:${height}:flags=lanczos,split[s0][s1];[s0]palettegen[p];[s1][p]paletteuse`,\n          \"-loop\",\n          \"0\",\n        ]\n      : [\n          \"-vf\",\n          \"format=yuv420p\",\n          \"-vcodec\",\n          \"libx264\",\n          \"-profile:v\",\n          \"high\",\n          ...(fast ? [\"-preset:v\", \"ultrafast\"] : [\"-preset:v\", \"medium\"]),\n          \"-crf\",\n          \"18\",\n\n          \"-movflags\",\n          \"faststart\",\n        ];\n\n    const audioOutputArgs = audioFilePath ? [\"-acodec\", \"aac\", \"-b:a\", \"128k\"] : [];\n\n    return [...audioOutputArgs, ...videoOutputArgs];\n  }\n\n  function startFfmpegWriterProcess() {\n    const args = [\n      \"-f\",\n      \"rawvideo\",\n      \"-vcodec\",\n      \"rawvideo\",\n      \"-pix_fmt\",\n      \"rgba\",\n      \"-s\",\n      `${width}x${height}`,\n      \"-r\",\n      framerateStr,\n      \"-i\",\n      \"-\",\n\n      ...(audioFilePath ? [\"-i\", audioFilePath] : []),\n\n      ...(!isGif ? [\"-map\", \"0:v:0\"] : []),\n      ...(audioFilePath ? [\"-map\", \"1:a:0\"] : []),\n\n      ...getOutputArgs(),\n\n      \"-y\",\n      outPath,\n    ];\n    return ffmpeg(args, {\n      encoding: \"buffer\",\n      buffer: false,\n      stdin: \"pipe\",\n      stdout: process.stdout,\n      stderr: process.stderr,\n    });\n  }\n\n  let outProcess: ResultPromise<Options> | undefined;\n  let outProcessExitCode;\n\n  let frameSource1;\n  let frameSource2;\n\n  let frameSource1Data;\n\n  let totalFramesWritten = 0;\n  let fromClipFrameAt = 0;\n  let toClipFrameAt = 0;\n\n  let transitionFromClipId = 0;\n\n  const getTransitionToClipId = () => transitionFromClipId + 1;\n  const getTransitionFromClip = () => clips[transitionFromClipId];\n  const getTransitionToClip = () => clips[getTransitionToClipId()];\n\n  const getSource = async (clip: ProcessedClip, clipIndex: number) =>\n    createFrameSource({\n      clip,\n      clipIndex,\n      width,\n      height,\n      channels,\n      verbose,\n      logTimes,\n      framerateStr,\n    });\n  const getTransitionFromSource = async () =>\n    getSource(getTransitionFromClip(), transitionFromClipId);\n  const getTransitionToSource = async () =>\n    getTransitionToClip() && getSource(getTransitionToClip(), getTransitionToClipId());\n\n  try {\n    try {\n      outProcess = startFfmpegWriterProcess();\n\n      let outProcessError;\n\n      outProcess.on(\"exit\", (code) => {\n        if (verbose) console.log(\"Output ffmpeg exited\", code);\n        outProcessExitCode = code;\n      });\n\n      // If we write and get an EPIPE (like when ffmpeg fails or is finished), we could get an unhandled rejection if we don't catch the promise\n      // (and meow causes the CLI to exit on unhandled rejections making it hard to see)\n      outProcess.catch((err) => {\n        outProcessError = err;\n      });\n\n      frameSource1 = await getTransitionFromSource();\n      frameSource2 = await getTransitionToSource();\n\n      while (!outProcessError) {\n        const transitionToClip = getTransitionToClip();\n        const transitionFromClip = getTransitionFromClip();\n        const fromClipNumFrames = Math.round(transitionFromClip.duration * fps);\n        const toClipNumFrames = transitionToClip && Math.round(transitionToClip.duration * fps);\n        const fromClipProgress = fromClipFrameAt / fromClipNumFrames;\n        const toClipProgress = transitionToClip && toClipFrameAt / toClipNumFrames;\n        const fromClipTime = transitionFromClip.duration * fromClipProgress;\n        const toClipTime = transitionToClip && transitionToClip.duration * toClipProgress;\n\n        const currentTransition = transitionFromClip.transition;\n        const transitionNumFrames = Math.round(currentTransition.duration * fps);\n        const runTransitionOnFrame = currentTransition.create({ width, height, channels });\n\n        // Each clip has two transitions, make sure we leave enough room:\n        const transitionNumFramesSafe = Math.floor(\n          Math.min(\n            Math.min(\n              fromClipNumFrames,\n              toClipNumFrames != null ? toClipNumFrames : Number.MAX_SAFE_INTEGER,\n            ) / 2,\n            transitionNumFrames,\n          ),\n        );\n        // How many frames into the transition are we? negative means not yet started\n        const transitionFrameAt = fromClipFrameAt - (fromClipNumFrames - transitionNumFramesSafe);\n\n        if (!verbose) {\n          const percentDone = Math.floor(100 * (totalFramesWritten / estimatedTotalFrames));\n          if (totalFramesWritten % 10 === 0)\n            process.stdout.write(`${String(percentDone).padStart(3, \" \")}% `);\n        }\n\n        // console.log({ transitionFrameAt, transitionNumFramesSafe })\n        // const transitionLastFrameIndex = transitionNumFramesSafe - 1;\n        const transitionLastFrameIndex = transitionNumFramesSafe;\n\n        // Done with transition?\n        if (transitionFrameAt >= transitionLastFrameIndex) {\n          transitionFromClipId += 1;\n          console.log(\n            `Done with transition, switching to next transitionFromClip (${transitionFromClipId})`,\n          );\n\n          if (!getTransitionFromClip()) {\n            console.log(\"No more transitionFromClip, done\");\n            break;\n          }\n\n          // Cleanup completed frameSource1, swap and load next frameSource2\n          await frameSource1.close();\n          frameSource1 = frameSource2;\n          frameSource2 = await getTransitionToSource();\n\n          fromClipFrameAt = transitionLastFrameIndex;\n          toClipFrameAt = 0;\n\n          continue;\n        }\n\n        if (logTimes) console.time(\"Read frameSource1\");\n        const newFrameSource1Data = await frameSource1.readNextFrame({ time: fromClipTime });\n        if (logTimes) console.timeEnd(\"Read frameSource1\");\n        // If we got no data, use the old data\n        // TODO maybe abort?\n        if (newFrameSource1Data) frameSource1Data = newFrameSource1Data;\n        else console.warn(\"No frame data returned, using last frame\");\n\n        const isInTransition =\n          frameSource2 && transitionNumFramesSafe > 0 && transitionFrameAt >= 0;\n\n        let outFrameData;\n\n        if (isInTransition) {\n          if (logTimes) console.time(\"Read frameSource2\");\n          const frameSource2Data = await frameSource2.readNextFrame({ time: toClipTime });\n          if (logTimes) console.timeEnd(\"Read frameSource2\");\n\n          if (frameSource2Data) {\n            const progress = transitionFrameAt / transitionNumFramesSafe;\n\n            if (logTimes) console.time(\"runTransitionOnFrame\");\n\n            outFrameData = runTransitionOnFrame({\n              fromFrame: frameSource1Data!,\n              toFrame: frameSource2Data,\n              progress: progress,\n            });\n\n            if (logTimes) console.timeEnd(\"runTransitionOnFrame\");\n          } else {\n            console.warn(\"Got no frame data from transitionToClip!\");\n            // We have probably reached end of clip2 but transition is not complete. Just pass thru clip1\n            outFrameData = frameSource1Data;\n          }\n        } else {\n          // Not in transition. Pass thru clip 1\n          outFrameData = frameSource1Data;\n        }\n\n        if (verbose) {\n          if (isInTransition)\n            console.log(\n              \"Writing frame:\",\n              totalFramesWritten,\n              \"from clip\",\n              transitionFromClipId,\n              `(frame ${fromClipFrameAt})`,\n              \"to clip\",\n              getTransitionToClipId(),\n              `(frame ${toClipFrameAt} / ${transitionNumFramesSafe})`,\n              currentTransition.name,\n              `${currentTransition.duration}s`,\n            );\n          else\n            console.log(\n              \"Writing frame:\",\n              totalFramesWritten,\n              \"from clip\",\n              transitionFromClipId,\n              `(frame ${fromClipFrameAt})`,\n            );\n          // console.log(outFrameData.length / 1e6, 'MB');\n        }\n\n        const nullOutput = false;\n\n        if (logTimes) console.time(\"outProcess.write\");\n\n        // If we don't wait, then we get EINVAL when dealing with high resolution files (big writes)\n        if (!nullOutput) await new Promise((r) => outProcess?.stdin?.write(outFrameData, r));\n\n        if (logTimes) console.timeEnd(\"outProcess.write\");\n\n        if (outProcessError) break;\n\n        totalFramesWritten += 1;\n        fromClipFrameAt += 1;\n        if (isInTransition) toClipFrameAt += 1;\n      } // End while loop\n\n      outProcess.stdin?.end();\n    } catch (err) {\n      outProcess?.kill();\n      throw err;\n    } finally {\n      if (verbose) console.log(\"Cleanup\");\n      if (frameSource1) await frameSource1.close();\n      if (frameSource2) await frameSource2.close();\n    }\n\n    try {\n      if (verbose) console.log(\"Waiting for output ffmpeg process to finish\");\n      await outProcess;\n    } catch (err) {\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      if (outProcessExitCode !== 0 && !(err as any).isTerminated) throw err;\n    }\n  } finally {\n    if (!keepTmp) await fsExtra.remove(tmpDir);\n  }\n\n  console.log();\n  console.log(\"Done. Output file can be found at:\");\n  console.log(outPath);\n}\n\n/**\n * Pure function to get a frame at a certain time.\n * TODO: I think this does not respect transition durations\n *\n * @param config - ConfigurationOptions.\n */\nexport async function renderSingleFrame(input: RenderSingleFrameConfig): Promise<void> {\n  const time = input.time ?? 0;\n\n  const config = new Configuration(input);\n  const {\n    clips: clipsIn,\n    allowRemoteRequests,\n    width = 800,\n    height = 600,\n    verbose,\n    logTimes,\n    outPath = `${Math.floor(Math.random() * 1e12)}.png`,\n    defaults,\n  } = config;\n\n  configureFf(config);\n\n  console.log({ clipsIn });\n\n  const { clips } = await parseConfig({\n    clips: clipsIn,\n    arbitraryAudio: [],\n    allowRemoteRequests,\n    defaults,\n  });\n  let clipStartTime = 0;\n  const clip = clips.find((c) => {\n    if (clipStartTime <= time && clipStartTime + c.duration > time) return true;\n    clipStartTime += c.duration;\n    return false;\n  });\n  assert(clip, \"No clip found at requested time\");\n  const clipIndex = clips.indexOf(clip);\n  const frameSource = await createFrameSource({\n    clip,\n    clipIndex,\n    width,\n    height,\n    channels,\n    verbose,\n    logTimes,\n    framerateStr: \"1\",\n  });\n  const rgba = await frameSource.readNextFrame({ time: time - clipStartTime });\n\n  // TODO converting rgba to png can be done more easily?\n  const canvas = createFabricCanvas({ width, height });\n  const fabricImage = await rgbaToFabricImage({ width, height, rgba });\n  canvas.add(fabricImage);\n  canvas.renderAll();\n  const internalCanvas = canvas.getNodeCanvas();\n  await fsExtra.writeFile(outPath, internalCanvas.toBuffer(\"image/png\"));\n  canvas.clear();\n  canvas.dispose();\n  await frameSource.close();\n}\n\nEditly.renderSingleFrame = renderSingleFrame;\n\nexport default Editly;\n"],"names":["clipAudioPath","args","fabric","title","dirname","rgba","easings.linear","flatMap","layerDuration"],"mappings":"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AA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,CAAA,EAAE,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,IAAG,GAAA,EAAI,CAAA,EAAE,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,CAAA,EAAE,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,KAAI,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,CAAA,EAAE,EAAA,EAAG,GAAA,EAAI,EAAA,EAAG,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,EAAA,EAAG,IAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,KAAI,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,EAAA,EAAG,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,IAAG,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,CAAA,EAAE,EAAA,EAAG,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,EAAA,EAAG,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,GAAA,EAAI,GAAA,EAAI,EAAA,EAAG,GAAA,EAAI,EAAA,EAAG,KAAI,CAAC,CAAA;AAEl7B,IAAI,SAAA,GAAY,CAAC,CAAA,EAAE,CAAA,EAAE,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,IAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,IAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,IAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,EAAA,EAAG,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"}